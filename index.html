<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Karyawan - PT Pertamina Drilling</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        .login-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-card {
            backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .static-text {
            white-space: nowrap;
        }
        
        .floating-header {
            backdrop-filter: blur(15px);
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(59, 130, 246, 0.9), rgba(99, 102, 241, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .dropdown-content {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8B4513;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50 min-h-full"><!-- Login Page -->
  <div id="loginPage" class="login-container flex items-center justify-center p-4">
   <div class="login-card rounded-2xl shadow-2xl max-w-md w-full p-8">
    <div class="text-center mb-8">
     <div class="flex justify-center mb-4"><img src="https://p1.hiclipart.com/preview/745/129/287/graphic-background-logo-line-pertamina-text-area-png-clipart.jpg" alt="Logo PT Pertamina Drilling" class="h-16 w-auto object-contain drop-shadow-lg" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';"> <span class="text-blue-600 text-4xl hidden">ğŸ¢</span>
     </div>
     <h1 class="text-2xl font-bold text-gray-900 mb-2">PT PERTAMINA DRILLING</h1>
     <p id="loginSubtitle" class="text-gray-600 text-sm">Sistem Manajemen Data Karyawan</p>
    </div>
    <form id="loginForm" class="space-y-6">
     <div><label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="username" name="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="Masukkan username Anda">
     </div>
     <div><label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
      <div class="relative"><input type="password" id="password" name="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors pr-12" placeholder="Masukkan password Anda"> <button type="button" onclick="togglePassword()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"> <span id="passwordToggleIcon">ğŸ‘ï¸</span> </button>
      </div>
     </div>
     <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
      <div class="flex items-start gap-2"><span class="text-blue-600 text-sm">â„¹ï¸</span>
       <div class="text-xs text-blue-800">
        <p class="font-semibold mb-1">Akun Login:</p>
        <p>Gunakan username dan password yang telah terdaftar di database sistem. Hubungi administrator jika belum memiliki akun.</p>
       </div>
      </div>
     </div>
     <div class="flex items-center justify-between"><label class="flex items-center"> <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2 text-sm text-gray-600">Ingat saya</span> </label>
     </div><button type="submit" id="loginButton" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"> <span id="loginButtonText">ğŸ” Masuk</span> </button>
    </form><!-- Login Error Message -->
    <div id="loginError" class="hidden mt-4 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
     <div class="flex items-center gap-2"><span>âŒ</span> <span id="loginErrorMessage">Username atau password salah!</span>
     </div>
    </div>
   </div>
  </div><!-- Main Application (Hidden by default) -->
  <div id="mainApplication" class="hidden"><!-- User Info Bar -->
   <div id="userInfoBar" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white py-2 px-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
     <div class="flex items-center gap-3"><span class="text-lg">ğŸ‘¤</span>
      <div><span class="font-semibold" id="currentUserName">User</span> <span class="text-green-100 text-sm ml-2" id="currentUserRole">(Role)</span>
      </div>
     </div>
     <div class="flex items-center gap-4"><span class="text-sm text-green-100" id="loginTime">Login: --:--</span> <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-1 rounded-lg transition-colors text-sm"> ğŸšª Logout </button>
     </div>
    </div>
   </div><!-- Navigation Bar -->
   <nav class="bg-gradient-to-r from-slate-800 via-gray-800 to-slate-900 text-white shadow-2xl border-b-4 border-gradient-to-r from-blue-500 to-indigo-500">
    <div class="max-w-7xl mx-auto px-4">
     <div class="flex justify-between items-center h-16">
      <div class="flex items-center space-x-8">
       <div class="flex items-center space-x-4"><img src="https://p1.hiclipart.com/preview/745/129/287/graphic-background-logo-line-pertamina-text-area-png-clipart.jpg" alt="Logo PT Pertamina Drilling" class="h-12 w-auto object-contain drop-shadow-2xl transform hover:scale-110 transition-transform duration-300" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';"> <span class="text-blue-300 text-sm hidden">ğŸ¢</span>
        <div class="text-lg font-bold text-white drop-shadow-lg flex items-center">
         PT PERTAMINA DRILLING
        </div>
       </div>
       <div class="hidden md:flex space-x-6" id="navigationMenu"><!-- Dashboard - Available for all roles --> <button onclick="showDashboard()" class="hover:text-blue-200 transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 font-semibold">ğŸ“Š Dashboard</button> <!-- Data Karyawan - Role-based access -->
        <div class="relative group" id="dataKaryawanMenu"><button class="hover:text-blue-200 transition-all duration-300 flex items-center gap-1 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10"> <span id="currentDepartmentTitle">Data Karyawan</span>
          <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg></button>
         <div class="absolute top-full left-0 mt-2 w-48 bg-white rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50 border border-gray-100">
          <div class="py-2"><button onclick="showDataKaryawan('Logistic')" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-800 transition-all duration-200 rounded-lg mx-2"> ğŸ“¦ Logistic </button> <button onclick="showDataKaryawan('Procurement')" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-800 transition-all duration-200 rounded-lg mx-2"> ğŸ›’ Procurement </button> <!-- Input Data - Only for Admin and Staff --> <button id="inputDataKaryawanBtn" onclick="openInputDataKaryawan()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50 hover:text-green-800 transition-all duration-200 rounded-lg mx-2"> ğŸ‘¥ Input Data Karyawan </button>
           <div class="border-t border-gray-200 my-2 mx-2"></div><button onclick="showDataKaryawan('')" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-800 transition-all duration-200 rounded-lg mx-2"> ğŸ‘¥ Semua Karyawan </button>
          </div>
         </div>
        </div><!-- Laporan - Role-based access -->
        <div class="relative group" id="laporanMenu"><button class="hover:text-blue-200 transition-all duration-300 flex items-center gap-1 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10"> <span>Laporan</span>
          <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg></button>
         <div class="absolute top-full left-0 mt-2 w-56 bg-white rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50 border border-gray-100">
          <div class="py-2"><!-- Input Laporan - Only for Admin and Staff --> <button id="inputLaporanBtn" onclick="openInputLaporan()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50 hover:text-green-800 transition-all duration-200 rounded-lg mx-2"> ğŸ“ Input Laporan </button> <button onclick="openDisplayLaporan()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-800 transition-all duration-200 rounded-lg mx-2"> ğŸ“Š Display Laporan </button> <!-- Print Laporan - Only for Admin and Staff --> <button id="printLaporanBtn" onclick="openPrintLaporan()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-purple-50 hover:to-violet-50 hover:text-purple-800 transition-all duration-200 rounded-lg mx-2"> ğŸ–¨ï¸ Print Laporan </button>
          </div>
         </div>
        </div><!-- Pengaturan - Only for Admin -->
        <div class="relative group" id="pengaturanMenu"><button class="hover:text-blue-200 transition-all duration-300 flex items-center gap-1 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10"> <span>Pengaturan</span>
          <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg></button>
         <div class="absolute top-full right-0 mt-2 w-64 bg-white rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50 border border-gray-100">
          <div class="py-2">
           <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b border-gray-100">
            Manajemen Data
           </div><button onclick="openBackupRestore()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-800 transition-all duration-200 rounded-lg mx-2"> ğŸ’¾ Backup &amp; Restore Data </button> <button onclick="openDataValidation()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50 hover:text-green-800 transition-all duration-200 rounded-lg mx-2"> âœ… Validasi Data </button> <button onclick="openDataSync()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-purple-50 hover:to-violet-50 hover:text-purple-800 transition-all duration-200 rounded-lg mx-2"> ğŸ”„ Sinkronisasi Data </button>
           <div class="border-t border-gray-200 my-2 mx-2"></div>
           <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide">
            Sistem &amp; Keamanan
           </div><button onclick="openUserManagement()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-orange-50 hover:to-amber-50 hover:text-orange-800 transition-all duration-200 rounded-lg mx-2"> ğŸ‘¥ Manajemen User </button> <button onclick="openSystemSettings()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-gray-50 hover:to-slate-50 hover:text-gray-800 transition-all duration-200 rounded-lg mx-2"> âš™ï¸ Pengaturan Sistem </button> <button onclick="openAuditLog()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-red-50 hover:to-pink-50 hover:text-red-800 transition-all duration-200 rounded-lg mx-2"> ğŸ“‹ Log Aktivitas </button>
           <div class="border-t border-gray-200 my-2 mx-2"></div>
           <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide">
            Bantuan &amp; Info
           </div><button onclick="openHelp()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-blue-50 hover:to-cyan-50 hover:text-blue-800 transition-all duration-200 rounded-lg mx-2"> â“ Bantuan &amp; Tutorial </button> <button onclick="openAbout()" class="w-full text-left block px-4 py-3 text-gray-800 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 hover:text-indigo-800 transition-all duration-200 rounded-lg mx-2"> â„¹ï¸ Tentang Sistem </button>
          </div>
         </div>
        </div>
       </div>
      </div>
      <div class="flex items-center space-x-4">
       <div class="text-right">
        <div id="currentTime" class="text-sm font-semibold text-white">
         00:00:00
        </div>
        <div id="currentDate" class="text-xs text-blue-200">
         Loading...
        </div>
       </div>
       <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-lg ring-2 ring-white ring-opacity-20"><span class="text-lg">ğŸ•</span>
       </div>
      </div>
     </div>
    </div>
   </nav><!-- Floating Header -->
   <header class="floating-header text-white py-6 mb-8 rounded-3xl mx-4 mt-4 shadow-2xl">
    <div class="container mx-auto px-6">
     <div class="text-center">
      <h1 class="static-text text-4xl font-bold">ğŸ“Š DATA KARYAWAN - SUPPLY CHAIN MANAGEMENT ğŸ“Š</h1>
     </div>
    </div>
   </header><!-- Department Tab Indicator -->
   <div id="departmentTabIndicator" class="container mx-auto px-4 mb-4 hidden">
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl shadow-lg p-4">
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-3"><span id="tabIcon" class="text-2xl">ğŸ“¦</span>
       <div>
        <h2 class="text-lg font-bold" id="tabTitle">Departemen Logistic</h2>
        <p class="text-blue-100 text-sm">Menampilkan data karyawan khusus departemen ini</p>
       </div>
      </div><button onclick="switchToDepartment('')" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition-colors text-sm"> ğŸ‘¥ Lihat Semua </button>
     </div>
    </div>
   </div><!-- Main Content - Dashboard Landing Page -->
   <main class="container mx-auto px-4 pb-8" id="mainDashboard"><!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
     <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-blue-100 text-sm">Total Karyawan</p>
        <p class="text-3xl font-bold" id="totalEmployees">0</p>
       </div>
       <div class="text-4xl opacity-80">
        ğŸ‘¥
       </div>
      </div>
     </div>
     <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-green-100 text-sm">Karyawan Aktif</p>
        <p class="text-3xl font-bold" id="activeEmployees">0</p>
       </div>
       <div class="text-4xl opacity-80">
        âœ…
       </div>
      </div>
     </div>
     <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-purple-100 text-sm">Foto Tersedia</p>
        <p class="text-3xl font-bold" id="employeesWithPhotos">0</p>
       </div>
       <div class="text-4xl opacity-80">
        ğŸ“·
       </div>
      </div>
     </div>
     <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-xl p-6 shadow-lg">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-orange-100 text-sm">Departemen</p>
        <p class="text-3xl font-bold" id="totalDepartments">0</p>
       </div>
       <div class="text-4xl opacity-80">
        ğŸ¢
       </div>
      </div>
     </div>
    </div><!-- Filters -->
    <div class="bg-gray-50 rounded-xl p-4 mb-6">
     <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div><label for="dashboardSearch" class="block text-sm font-medium text-gray-700 mb-2">Pencarian</label> <input type="text" id="dashboardSearch" placeholder="Cari nama, jabatan, nopek..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>
      <div><label for="dashboardDepartmentFilter" class="block text-sm font-medium text-gray-700 mb-2">Departemen</label> <select id="dashboardDepartmentFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Semua Departemen</option> </select>
      </div>
      <div><label for="dashboardStatusFilter" class="block text-sm font-medium text-gray-700 mb-2">Status</label> <select id="dashboardStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Semua Status</option> <option value="Aktif">Aktif</option> <option value="Tidak Aktif">Tidak Aktif</option> </select>
      </div>
      <div class="flex items-end gap-2"><button onclick="refreshDashboard()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2"> <span id="dashboardRefreshIcon">ğŸ”„</span> Refresh </button> <button onclick="addTestPhotos()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors"> ğŸ“· Test Foto </button> <button onclick="exportPersonnelData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"> ğŸ“Š Export </button>
      </div>
     </div>
    </div><!-- Data Info -->
    <div class="bg-white rounded-lg p-3 mb-4 border border-gray-200">
     <div class="flex justify-between items-center text-sm">
      <div class="text-gray-600">
       Menampilkan <span id="dashboardShowingStart">0</span> - <span id="dashboardShowingEnd">0</span> dari <span id="dashboardTotalEntries">0</span> personel
      </div>
      <div id="dashboardLoadingIndicator" class="hidden flex items-center gap-2">
       <div class="loading"></div><span class="text-gray-600">Memuat data...</span>
      </div>
     </div>
    </div><!-- Personnel Grid -->
    <div id="personnelGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6"><!-- Personnel cards will be populated here -->
    </div><!-- Pagination -->
    <div class="bg-white rounded-lg p-4">
     <div class="flex justify-center">
      <nav id="dashboardPagination" class="flex space-x-2"><!-- Pagination buttons will be generated here -->
      </nav>
     </div>
    </div>
   </main><!-- Data Karyawan Table Section (Hidden by default) -->
   <main class="container mx-auto px-4 pb-8 hidden" id="dataKaryawanSection"><!-- Controls Section -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"><!-- Search -->
      <div><label for="searchInput" class="block text-sm font-medium text-gray-700 mb-2">Pencarian Cepat</label> <input type="text" id="searchInput" placeholder="Cari nama, jabatan, departemen..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
      </div><!-- Department Filter -->
      <div class="relative"><label for="departmentFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter Departemen</label> <select id="departmentFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"> <option value="">Semua Departemen</option> </select>
      </div><!-- Position Filter -->
      <div class="relative"><label for="positionFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter Jabatan</label> <select id="positionFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"> <option value="">Semua Jabatan</option> </select>
      </div><!-- Entries per page -->
      <div><label for="entriesSelect" class="block text-sm font-medium text-gray-700 mb-2">Tampilkan</label> <select id="entriesSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"> <option value="10">10 data</option> <option value="20">20 data</option> <option value="50">50 data</option> <option value="100">100 data</option> <option value="all">Semua data</option> </select>
      </div>
     </div><!-- Action Buttons -->
     <div class="flex flex-wrap gap-3"><button id="refreshBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"> <span id="refreshIcon">ğŸ”„</span> Refresh Data </button> <button id="resetBtn" class="bg-gradient-to-r from-slate-600 to-gray-600 hover:from-slate-700 hover:to-gray-700 text-white px-4 py-2 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"> ğŸ”„ Reset Filter </button> <a href="https://docs.google.com/spreadsheets/d/1En78lujaSddXeQ3lXQNWTe48C-6GpQ2lvApxiuqccBQ/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white px-4 py-2 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"> ğŸ“Š Data Spreadsheet </a>
     </div>
    </div><!-- Data Info -->
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6">
     <div class="flex justify-between items-center">
      <div class="text-gray-600">
       Menampilkan <span id="showingStart">0</span> - <span id="showingEnd">0</span> dari <span id="totalEntries">0</span> data
      </div>
      <div id="loadingIndicator" class="hidden">
       <div class="loading"></div><span class="ml-2 text-gray-600">Memuat data...</span>
      </div>
     </div>
    </div><!-- Table Container -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
     <div class="table-container">
      <table class="w-full">
       <thead class="bg-gray-600 text-white sticky top-0">
        <tr>
         <th class="px-4 py-3 text-left text-sm font-semibold">Nopek</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Nama Lengkap</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Jabatan</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Tempat Kerja</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Departemen</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Tempat Lahir</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Tanggal Lahir</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Umur</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Jenis Kelamin</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Alamat</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">No. HP</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Email</th>
         <th class="px-4 py-3 text-left text-sm font-semibold">Status</th>
        </tr>
       </thead>
       <tbody id="employeeTableBody" class="divide-y divide-gray-200"><!-- Data will be populated here -->
       </tbody>
      </table>
     </div>
    </div><!-- Pagination -->
    <div class="bg-white rounded-2xl shadow-lg p-4 mt-6">
     <div class="flex justify-center">
      <nav id="pagination" class="flex space-x-2"><!-- Pagination buttons will be generated here -->
      </nav>
     </div>
    </div>
   </main><!-- Photo View Modal -->
   <div id="photoViewModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-4">
       <h3 class="text-xl font-bold text-gray-900">Foto Karyawan</h3><button onclick="closePhotoView()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="text-center">
       <div class="mb-4">
        <div id="viewPhotoContainer" class="w-64 h-80 mx-auto bg-gray-100 rounded-lg overflow-hidden shadow-lg"><!-- Photo will be displayed here -->
        </div>
       </div>
       <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
        <div class="text-blue-800">
         <p class="font-semibold text-lg" id="viewEmployeeName">-</p>
         <p class="text-sm text-blue-600">Nopek: <span id="viewEmployeeNopek">-</span></p>
         <p class="text-xs text-blue-500 mt-2">Upload: <span id="viewUploadDate">-</span></p>
        </div>
       </div>
       <div id="viewPhotoNotes" class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm text-gray-700 hidden">
        <p class="font-medium mb-1">Catatan:</p>
        <p id="viewNotesContent">-</p>
       </div>
      </div>
      <div class="border-t pt-4 mt-4">
       <div class="flex gap-3"><button onclick="closePhotoView()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-colors"> Tutup </button> <button onclick="editPhotoFromView()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"> <span>âœï¸</span> Edit Foto </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Input Data Karyawan Modal -->
   <div id="inputDataKaryawanModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">ğŸ‘¥</span>
        <h3 class="text-2xl font-bold text-gray-900">Input Data Karyawan</h3>
       </div><button onclick="closeInputDataKaryawan()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
       <div class="flex items-start gap-3"><span class="text-blue-600 text-lg">ğŸ‘¥</span>
        <div class="text-sm text-blue-800">
         <p class="font-semibold mb-1">Petunjuk Input Data Karyawan (Terintegrasi dengan Tally):</p>
         <ul class="list-disc list-inside space-y-1 text-xs">
          <li>Form ini terintegrasi langsung dengan database sistem</li>
          <li>Isi form input data karyawan dengan lengkap dan akurat</li>
          <li>Pastikan Nopek (Nomor Pekerja) unik dan tidak duplikat</li>
          <li>Semua field yang wajib diisi harus dilengkapi</li>
          <li>Data akan tersimpan otomatis ke spreadsheet setelah submit berhasil</li>
          <li><strong>Setelah input, klik tombol "Refresh Data" untuk melihat data terbaru</strong></li>
          <li>Data akan muncul di tabel dan dashboard setelah refresh</li>
         </ul>
        </div>
       </div>
      </div><!-- Form Container -->
      <div class="bg-gray-50 rounded-xl p-4 mb-6">
       <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2"><span class="text-lg">ğŸ“</span>
         <div><span class="text-sm font-medium text-gray-700">Form Input Data Karyawan Online</span>
          <div class="flex items-center gap-2 mt-1"><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"> ğŸ”— Terintegrasi dengan Tally </span> <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"> ğŸ“Š Auto-sync ke Database </span>
          </div>
         </div>
        </div>
        <div class="flex gap-2"><button onclick="refreshDataKaryawanForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm"> <span>ğŸ”„</span> Refresh Form </button> <button onclick="refreshDataAfterInput()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm"> <span>âœ…</span> Refresh Data </button>
        </div>
       </div><!-- Iframe Container -->
       <div class="bg-white rounded-lg shadow-inner"><iframe id="inputDataKaryawanFrame" src="https://tally.so/r/wdL77d" width="100%" height="600" frameborder="0" marginheight="0" marginwidth="0" class="rounded-lg"> Loading form... </iframe>
       </div>
      </div><!-- Success Message -->
      <div id="dataKaryawanSuccessMessage" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
       <div class="flex items-center gap-3"><span class="text-green-600 text-lg">âœ…</span>
        <div class="text-sm text-green-800">
         <p class="font-semibold">Data karyawan berhasil disimpan!</p>
         <p class="text-xs">Data telah tersimpan ke database dan akan muncul di tabel setelah refresh.</p>
        </div>
       </div>
      </div><!-- Action Buttons -->
      <div class="border-t pt-4">
       <div class="flex gap-3 justify-center"><button onclick="closeInputDataKaryawan()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-lg transition-colors"> Tutup </button> <button onclick="refreshDataAfterInput(); closeInputDataKaryawan();" class="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg transition-colors flex items-center gap-2"> <span>âœ…</span> Selesai &amp; Refresh Data </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Input Laporan Modal -->
   <div id="inputLaporanModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“</span>
        <h3 class="text-2xl font-bold text-gray-900">Input Laporan</h3>
       </div><button onclick="closeInputLaporan()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
       <div class="flex items-start gap-3"><span class="text-green-600 text-lg">â„¹ï¸</span>
        <div class="text-sm text-green-800">
         <p class="font-semibold mb-1">Petunjuk Pengisian Laporan:</p>
         <ul class="list-disc list-inside space-y-1 text-xs">
          <li>Isi semua field yang diperlukan dengan lengkap dan akurat</li>
          <li>Pastikan data yang dimasukkan sudah benar sebelum submit</li>
          <li>Gunakan tombol "Refresh Form" untuk mengosongkan form jika ingin mengisi ulang</li>
          <li>Form akan tersimpan otomatis setelah submit berhasil</li>
         </ul>
        </div>
       </div>
      </div><!-- Form Container -->
      <div class="bg-gray-50 rounded-xl p-4 mb-6">
       <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2"><span class="text-lg">ğŸŒ</span> <span class="text-sm font-medium text-gray-700">Form Input Laporan Online</span>
        </div><button onclick="refreshInputForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm"> <span>ğŸ”„</span> Refresh Form </button>
       </div><!-- Iframe Container -->
       <div class="bg-white rounded-lg shadow-inner"><iframe id="inputLaporanFrame" src="https://tally.so/r/mZ48Ez" width="100%" height="600" frameborder="0" marginheight="0" marginwidth="0" class="rounded-lg"> Loading form... </iframe>
       </div>
      </div><!-- Action Buttons -->
      <div class="border-t pt-4">
       <div class="flex justify-center"><button onclick="closeInputLaporan()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-lg transition-colors"> Tutup </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Display Laporan Modal -->
   <div id="displayLaporanModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“Š</span>
        <h3 class="text-2xl font-bold text-gray-900">Display Laporan</h3>
       </div><button onclick="closeDisplayLaporan()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
       <div class="flex items-center gap-3"><span class="text-blue-600 text-lg">ğŸ“ˆ</span>
        <div class="text-sm text-blue-800">
         <p class="font-semibold">Tampilan Laporan</p>
         <p class="text-xs">Menampilkan data laporan yang telah disubmit melalui form input</p>
        </div>
       </div>
      </div><!-- Report Controls -->
      <div class="bg-gray-50 rounded-xl p-4 mb-6">
       <div class="flex flex-wrap gap-4 items-center justify-between">
        <div class="flex items-center gap-4">
         <div><label for="reportSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Pencarian Laporan</label> <input type="text" id="reportSearchInput" placeholder="Cari rig, lokasi, personel..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
         </div>
         <div><label for="reportDateFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter Tanggal</label> <input type="date" id="reportDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
         </div>
        </div>
        <div class="flex gap-2"><button onclick="refreshReportData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2"> <span id="reportRefreshIcon">ğŸ”„</span> Refresh </button> <button onclick="resetReportFilters()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors"> ğŸ”„ Reset </button>
        </div>
       </div>
      </div><!-- Report Data Info -->
      <div class="bg-white rounded-lg p-3 mb-4 border border-gray-200">
       <div class="flex justify-between items-center text-sm">
        <div class="text-gray-600">
         Menampilkan <span id="reportShowingStart">0</span> - <span id="reportShowingEnd">0</span> dari <span id="reportTotalEntries">0</span> laporan
        </div>
        <div id="reportLoadingIndicator" class="hidden flex items-center gap-2">
         <div class="loading"></div><span class="text-gray-600">Memuat laporan...</span>
        </div>
       </div>
      </div><!-- Report Table -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
       <div class="table-container" style="max-height: 500px; overflow-y: auto;">
        <table class="w-full">
         <thead class="bg-gray-600 text-white sticky top-0">
          <tr>
           <th class="px-4 py-3 text-left text-sm font-semibold">Tanggal</th>
           <th class="px-4 py-3 text-left text-sm font-semibold">Rig PDSI</th>
           <th class="px-4 py-3 text-left text-sm font-semibold">Lokasi</th>
           <th class="px-4 py-3 text-left text-sm font-semibold">Status</th>
           <th class="px-4 py-3 text-left text-sm font-semibold">Personel In Charge</th>
           <th class="px-4 py-3 text-left text-sm font-semibold">Aktivitas Pekerja</th>
          </tr>
         </thead>
         <tbody id="reportTableBody" class="divide-y divide-gray-200">
          <tr>
           <td colspan="6" class="px-4 py-8 text-center text-gray-500">
            <div class="flex flex-col items-center gap-3">
             <div class="text-4xl">
              ğŸ“Š
             </div>
             <div>
              Memuat data laporan...
             </div>
            </div></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div><!-- Report Pagination -->
      <div class="bg-white rounded-lg p-4 mt-4">
       <div class="flex justify-center">
        <nav id="reportPagination" class="flex space-x-2"><!-- Pagination buttons will be generated here -->
        </nav>
       </div>
      </div>
      <div class="border-t pt-4 mt-6">
       <div class="flex gap-3"><button onclick="closeDisplayLaporan()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-lg transition-colors"> Tutup </button> <button onclick="refreshDisplayLaporan()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"> <span>ğŸ”„</span> Refresh Data </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Dashboard Modal -->
   <div id="dashboardModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-7xl w-full mx-4 max-h-[95vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“Š</span>
        <h3 class="text-2xl font-bold text-gray-900">Dashboard Personel</h3>
       </div><button onclick="closeDashboard()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div><!-- Statistics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
       <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-blue-100 text-sm">Total Karyawan</p>
          <p class="text-3xl font-bold" id="totalEmployees">0</p>
         </div>
         <div class="text-4xl opacity-80">
          ğŸ‘¥
         </div>
        </div>
       </div>
       <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-green-100 text-sm">Karyawan Aktif</p>
          <p class="text-3xl font-bold" id="activeEmployees">0</p>
         </div>
         <div class="text-4xl opacity-80">
          âœ…
         </div>
        </div>
       </div>
       <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-purple-100 text-sm">Foto Tersedia</p>
          <p class="text-3xl font-bold" id="employeesWithPhotos">0</p>
         </div>
         <div class="text-4xl opacity-80">
          ğŸ“·
         </div>
        </div>
       </div>
       <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-xl p-6 shadow-lg">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-orange-100 text-sm">Departemen</p>
          <p class="text-3xl font-bold" id="totalDepartments">0</p>
         </div>
         <div class="text-4xl opacity-80">
          ğŸ¢
         </div>
        </div>
       </div>
      </div><!-- Filters -->
      <div class="bg-gray-50 rounded-xl p-4 mb-6">
       <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div><label for="dashboardSearch" class="block text-sm font-medium text-gray-700 mb-2">Pencarian</label> <input type="text" id="dashboardSearch" placeholder="Cari nama, jabatan, nopek..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label for="dashboardDepartmentFilter" class="block text-sm font-medium text-gray-700 mb-2">Departemen</label> <select id="dashboardDepartmentFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Semua Departemen</option> </select>
        </div>
        <div><label for="dashboardStatusFilter" class="block text-sm font-medium text-gray-700 mb-2">Status</label> <select id="dashboardStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Semua Status</option> <option value="Aktif">Aktif</option> <option value="Tidak Aktif">Tidak Aktif</option> </select>
        </div>
        <div class="flex items-end gap-2"><button onclick="refreshDashboard()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2"> <span id="dashboardRefreshIcon">ğŸ”„</span> Refresh </button> <button onclick="addTestPhotos()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors"> ğŸ“· Test Foto </button> <button onclick="exportPersonnelData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"> ğŸ“Š Export </button>
        </div>
       </div>
      </div><!-- Data Info -->
      <div class="bg-white rounded-lg p-3 mb-4 border border-gray-200">
       <div class="flex justify-between items-center text-sm">
        <div class="text-gray-600">
         Menampilkan <span id="dashboardShowingStart">0</span> - <span id="dashboardShowingEnd">0</span> dari <span id="dashboardTotalEntries">0</span> personel
        </div>
        <div id="dashboardLoadingIndicator" class="hidden flex items-center gap-2">
         <div class="loading"></div><span class="text-gray-600">Memuat data...</span>
        </div>
       </div>
      </div><!-- Personnel Grid -->
      <div id="personnelGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6"><!-- Personnel cards will be populated here -->
      </div><!-- Pagination -->
      <div class="bg-white rounded-lg p-4">
       <div class="flex justify-center">
        <nav id="dashboardPagination" class="flex space-x-2"><!-- Pagination buttons will be generated here -->
        </nav>
       </div>
      </div>
      <div class="border-t pt-4 mt-6">
       <div class="flex justify-center"><button onclick="closeDashboard()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-lg transition-colors"> Tutup Dashboard </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Backup & Restore Modal -->
   <div id="backupRestoreModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">ğŸ’¾</span>
        <h3 class="text-2xl font-bold text-gray-900">Backup &amp; Restore Data</h3>
       </div><button onclick="closeBackupRestore()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Backup Section -->
       <div class="bg-blue-50 rounded-xl p-6">
        <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center gap-2"><span>ğŸ“¤</span> Backup Data</h4>
        <p class="text-sm text-blue-700 mb-4">Buat cadangan data karyawan dan laporan untuk keamanan data.</p>
        <div class="space-y-3 mb-4"><label class="flex items-center gap-2"> <input type="checkbox" checked class="text-blue-600"> <span class="text-sm">Data Karyawan</span> </label> <label class="flex items-center gap-2"> <input type="checkbox" checked class="text-blue-600"> <span class="text-sm">Data Laporan</span> </label> <label class="flex items-center gap-2"> <input type="checkbox" checked class="text-blue-600"> <span class="text-sm">Foto Karyawan</span> </label> <label class="flex items-center gap-2"> <input type="checkbox" class="text-blue-600"> <span class="text-sm">Pengaturan Sistem</span> </label>
        </div><button onclick="createBackup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"> <span>ğŸ’¾</span> Buat Backup </button>
       </div><!-- Restore Section -->
       <div class="bg-green-50 rounded-xl p-6">
        <h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center gap-2"><span>ğŸ“¥</span> Restore Data</h4>
        <p class="text-sm text-green-700 mb-4">Pulihkan data dari file backup yang tersimpan.</p>
        <div class="space-y-4">
         <div><label class="block text-sm font-medium text-green-700 mb-2">Pilih File Backup</label> <input type="file" accept=".json,.csv" class="w-full px-3 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500">
         </div>
         <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
          <div class="flex items-start gap-2"><span class="text-yellow-600">âš ï¸</span>
           <div class="text-xs text-yellow-800">
            <p class="font-semibold">Peringatan:</p>
            <p>Restore akan mengganti semua data yang ada. Pastikan Anda sudah membuat backup terlebih dahulu.</p>
           </div>
          </div>
         </div><button onclick="restoreData()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"> <span>ğŸ“¥</span> Restore Data </button>
        </div>
       </div>
      </div><!-- Backup History -->
      <div class="mt-6 bg-gray-50 rounded-xl p-6">
       <h4 class="text-lg font-semibold text-gray-800 mb-4">Riwayat Backup</h4>
       <div class="space-y-2" id="backupHistory">
        <div class="flex items-center justify-between bg-white p-3 rounded-lg">
         <div>
          <p class="font-medium text-sm">backup_2024-12-20_14-30.json</p>
          <p class="text-xs text-gray-500">20 Desember 2024, 14:30 WIB</p>
         </div>
         <div class="flex gap-2"><button class="text-blue-600 hover:text-blue-800 text-sm">ğŸ“¥ Restore</button> <button class="text-red-600 hover:text-red-800 text-sm">ğŸ—‘ï¸ Hapus</button>
         </div>
        </div>
       </div>
      </div>
      <div class="border-t pt-4 mt-6"><button onclick="closeBackupRestore()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-lg transition-colors"> Tutup </button>
      </div>
     </div>
    </div>
   </div><!-- Data Validation Modal -->
   <div id="dataValidationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">âœ…</span>
        <h3 class="text-2xl font-bold text-gray-900">Validasi Data</h3>
       </div><button onclick="closeDataValidation()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
       <div class="bg-green-50 rounded-xl p-4 text-center">
        <div class="text-3xl text-green-600 mb-2">
         âœ…
        </div>
        <div class="text-2xl font-bold text-green-800" id="validDataCount">
         0
        </div>
        <div class="text-sm text-green-600">
         Data Valid
        </div>
       </div>
       <div class="bg-yellow-50 rounded-xl p-4 text-center">
        <div class="text-3xl text-yellow-600 mb-2">
         âš ï¸
        </div>
        <div class="text-2xl font-bold text-yellow-800" id="warningDataCount">
         0
        </div>
        <div class="text-sm text-yellow-600">
         Peringatan
        </div>
       </div>
       <div class="bg-red-50 rounded-xl p-4 text-center">
        <div class="text-3xl text-red-600 mb-2">
         âŒ
        </div>
        <div class="text-2xl font-bold text-red-800" id="errorDataCount">
         0
        </div>
        <div class="text-sm text-red-600">
         Error
        </div>
       </div>
      </div>
      <div class="bg-gray-50 rounded-xl p-4 mb-6">
       <div class="flex items-center justify-between mb-4">
        <h4 class="font-semibold text-gray-800">Hasil Validasi</h4><button onclick="runDataValidation()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2"> <span>ğŸ”</span> Jalankan Validasi </button>
       </div>
       <div id="validationResults" class="space-y-2">
        <div class="text-center text-gray-500 py-8">
         Klik "Jalankan Validasi" untuk memulai pemeriksaan data
        </div>
       </div>
      </div>
      <div class="border-t pt-4"><button onclick="closeDataValidation()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-lg transition-colors"> Tutup </button>
      </div>
     </div>
    </div>
   </div><!-- System Settings Modal -->
   <div id="systemSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">âš™ï¸</span>
        <h3 class="text-2xl font-bold text-gray-900">Pengaturan Sistem</h3>
       </div><button onclick="closeSystemSettings()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="space-y-6"><!-- General Settings -->
       <div class="bg-gray-50 rounded-xl p-6">
        <h4 class="text-lg font-semibold text-gray-800 mb-4">Pengaturan Umum</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Perusahaan</label> <input type="text" value="PT PERTAMINA DRILLING" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Zona Waktu</label> <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option>WIB (UTC+7)</option> <option>WITA (UTC+8)</option> <option>WIT (UTC+9)</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Bahasa Sistem</label> <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option>Bahasa Indonesia</option> <option>English</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Format Tanggal</label> <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option>DD/MM/YYYY</option> <option>MM/DD/YYYY</option> <option>YYYY-MM-DD</option> </select>
         </div>
        </div>
       </div><!-- Data Settings -->
       <div class="bg-blue-50 rounded-xl p-6">
        <h4 class="text-lg font-semibold text-blue-800 mb-4">Pengaturan Data</h4>
        <div class="space-y-4">
         <div class="flex items-center justify-between">
          <div>
           <p class="font-medium text-blue-800">Auto Backup Harian</p>
           <p class="text-sm text-blue-600">Backup otomatis setiap hari pada pukul 02:00</p>
          </div><label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" checked class="sr-only peer">
           <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
         </div>
         <div class="flex items-center justify-between">
          <div>
           <p class="font-medium text-blue-800">Validasi Data Otomatis</p>
           <p class="text-sm text-blue-600">Periksa konsistensi data secara berkala</p>
          </div><label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" checked class="sr-only peer">
           <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
         </div>
        </div>
       </div><!-- Security Settings -->
       <div class="bg-red-50 rounded-xl p-6">
        <h4 class="text-lg font-semibold text-red-800 mb-4">Pengaturan Keamanan</h4>
        <div class="space-y-4">
         <div><label class="block text-sm font-medium text-red-700 mb-2">Timeout Session (menit)</label> <input type="number" value="30" min="5" max="120" class="w-full px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500">
         </div>
         <div class="flex items-center justify-between">
          <div>
           <p class="font-medium text-red-800">Log Aktivitas</p>
           <p class="text-sm text-red-600">Catat semua aktivitas pengguna</p>
          </div><label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" checked class="sr-only peer">
           <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div></label>
         </div>
        </div>
       </div>
      </div>
      <div class="border-t pt-4 mt-6">
       <div class="flex gap-3"><button onclick="closeSystemSettings()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-lg transition-colors"> Batal </button> <button onclick="saveSystemSettings()" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg transition-colors flex items-center gap-2"> <span>ğŸ’¾</span> Simpan Pengaturan </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Help Modal -->
   <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">â“</span>
        <h3 class="text-2xl font-bold text-gray-900">Bantuan &amp; Tutorial</h3>
       </div><button onclick="closeHelp()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Quick Start -->
       <div class="bg-blue-50 rounded-xl p-6">
        <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center gap-2"><span>ğŸš€</span> Panduan Cepat</h4>
        <div class="space-y-3 text-sm text-blue-700">
         <div class="flex items-start gap-2"><span class="font-bold">1.</span>
          <div>
           <p class="font-medium">Input Data Karyawan</p>
           <p>Gunakan menu "Input Data Karyawan" untuk menambah data baru</p>
          </div>
         </div>
         <div class="flex items-start gap-2"><span class="font-bold">2.</span>
          <div>
           <p class="font-medium">Upload Foto</p>
           <p>Klik tombol "ğŸ“·" pada dashboard untuk upload foto karyawan</p>
          </div>
         </div>
         <div class="flex items-start gap-2"><span class="font-bold">3.</span>
          <div>
           <p class="font-medium">Buat Laporan</p>
           <p>Gunakan menu "Input Laporan" untuk membuat laporan aktivitas</p>
          </div>
         </div>
        </div>
       </div><!-- FAQ -->
       <div class="bg-green-50 rounded-xl p-6">
        <h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center gap-2"><span>â“</span> FAQ</h4>
        <div class="space-y-3 text-sm">
         <details class="bg-white rounded-lg p-3"><summary class="font-medium text-green-800 cursor-pointer">Bagaimana cara mengedit data karyawan?</summary>
          <p class="text-green-700 mt-2">Buka Dashboard â†’ Klik "Detail" pada kartu karyawan â†’ Klik "Edit Data"</p>
         </details>
         <details class="bg-white rounded-lg p-3"><summary class="font-medium text-green-800 cursor-pointer">Format foto yang didukung?</summary>
          <p class="text-green-700 mt-2">JPG, PNG dengan ukuran maksimal 2MB</p>
         </details>
         <details class="bg-white rounded-lg p-3"><summary class="font-medium text-green-800 cursor-pointer">Bagaimana cara backup data?</summary>
          <p class="text-green-700 mt-2">Pengaturan â†’ Backup &amp; Restore â†’ Klik "Buat Backup"</p>
         </details>
        </div>
       </div>
      </div><!-- Video Tutorials -->
      <div class="mt-6 bg-purple-50 rounded-xl p-6">
       <h4 class="text-lg font-semibold text-purple-800 mb-4 flex items-center gap-2"><span>ğŸ¥</span> Video Tutorial</h4>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-lg p-4 text-center">
         <div class="text-4xl mb-2">
          ğŸ¬
         </div>
         <p class="font-medium text-sm">Input Data Karyawan</p>
         <p class="text-xs text-gray-600 mb-3">5 menit</p><button class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs"> â–¶ï¸ Tonton </button>
        </div>
        <div class="bg-white rounded-lg p-4 text-center">
         <div class="text-4xl mb-2">
          ğŸ“·
         </div>
         <p class="font-medium text-sm">Upload Foto</p>
         <p class="text-xs text-gray-600 mb-3">3 menit</p><button class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs"> â–¶ï¸ Tonton </button>
        </div>
        <div class="bg-white rounded-lg p-4 text-center">
         <div class="text-4xl mb-2">
          ğŸ“Š
         </div>
         <p class="font-medium text-sm">Membuat Laporan</p>
         <p class="text-xs text-gray-600 mb-3">7 menit</p><button class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs"> â–¶ï¸ Tonton </button>
        </div>
       </div>
      </div>
      <div class="border-t pt-4 mt-6">
       <div class="flex gap-3"><button onclick="closeHelp()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-lg transition-colors"> Tutup </button> <button onclick="contactSupport()" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg transition-colors flex items-center gap-2"> <span>ğŸ“</span> Hubungi Support </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- User Management Modal -->
   <div id="userManagementModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">ğŸ‘¥</span>
        <h3 class="text-2xl font-bold text-gray-900">Manajemen User</h3>
       </div><button onclick="closeUserManagement()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
       <div class="flex items-center gap-3"><span class="text-orange-600 text-lg">ğŸ‘¥</span>
        <div class="text-sm text-orange-800">
         <p class="font-semibold">Manajemen User Sistem</p>
         <p class="text-xs">Kelola akun pengguna, reset password, dan tambah akun baru</p>
        </div>
       </div>
      </div><!-- User List -->
      <div class="bg-gray-50 rounded-xl p-6 mb-6">
       <div class="flex items-center justify-between mb-4">
        <h4 class="text-lg font-semibold text-gray-800">Daftar User Aktif</h4>
        <div class="flex gap-2"><button onclick="refreshUserList()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2"> <span>ğŸ”„</span> Refresh </button> <button onclick="openAddNewAccount()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2"> <span>â•</span> Tambah User </button>
        </div>
       </div>
       <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <table class="w-full">
         <thead class="bg-gray-600 text-white">
          <tr>
           <th class="px-4 py-3 text-left text-sm font-semibold">Username</th>
           <th class="px-4 py-3 text-left text-sm font-semibold">Nama Lengkap</th>
           <th class="px-4 py-3 text-left text-sm font-semibold">Role</th>
           <th class="px-4 py-3 text-left text-sm font-semibold">Departemen</th>
           <th class="px-4 py-3 text-left text-sm font-semibold">Email</th>
           <th class="px-4 py-3 text-left text-sm font-semibold">Aksi</th>
          </tr>
         </thead>
         <tbody id="userListTableBody" class="divide-y divide-gray-200"><!-- User list will be populated here -->
         </tbody>
        </table>
       </div>
      </div>
      <div class="border-t pt-4"><button onclick="closeUserManagement()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-lg transition-colors"> Tutup </button>
      </div>
     </div>
    </div>
   </div><!-- Reset Password Modal -->
   <div id="resetPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">ğŸ”‘</span>
        <h3 class="text-xl font-bold text-gray-900">Reset Password</h3>
       </div><button onclick="closeResetPassword()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <form id="resetPasswordForm" class="space-y-4">
       <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
        <div class="flex items-center gap-2 text-purple-800"><span class="text-lg">ğŸ”‘</span>
         <div>
          <p class="font-semibold text-sm">Reset Password User</p>
          <p class="text-xs">Pilih user dan masukkan password baru</p>
         </div>
        </div>
       </div>
       <div><label for="resetUserSelect" class="block text-sm font-medium text-gray-700 mb-2">Pilih User</label> <select id="resetUserSelect" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"> <option value="">-- Pilih User --</option> </select>
       </div>
       <div id="selectedUserInfo" class="hidden bg-gray-50 rounded-lg p-3">
        <p class="text-sm text-gray-700"><span class="font-medium">User:</span> <span id="selectedUserName">-</span><br><span class="font-medium">Role:</span> <span id="selectedUserRole">-</span></p>
       </div>
       <div><label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">Password Baru</label>
        <div class="relative"><input type="password" id="newPassword" name="newPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent pr-12" placeholder="Masukkan password baru"> <button type="button" onclick="toggleNewPassword()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"> <span id="newPasswordToggleIcon">ğŸ‘ï¸</span> </button>
        </div>
       </div>
       <div><label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Konfirmasi Password</label> <input type="password" id="confirmPassword" name="confirmPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Konfirmasi password baru">
       </div>
       <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
        <div class="flex items-start gap-2"><span class="text-yellow-600">âš ï¸</span>
         <div class="text-xs text-yellow-800">
          <p class="font-semibold">Peringatan:</p>
          <p>Password akan direset dan user harus menggunakan password baru untuk login.</p>
         </div>
        </div>
       </div>
       <div id="resetPasswordMessage" class="hidden"></div>
       <div class="border-t pt-4">
        <div class="flex gap-3"><button type="button" onclick="closeResetPassword()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-colors"> Batal </button> <button type="submit" id="resetPasswordBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"> <span>ğŸ”‘</span> Reset Password </button>
        </div>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Edit Data Modal -->
   <div id="editDataModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">âœï¸</span>
        <h3 class="text-2xl font-bold text-gray-900">Edit Data Karyawan</h3>
       </div><button onclick="closeEditDataModal()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
       <div class="flex items-start gap-3"><span class="text-blue-600 text-lg">âœï¸</span>
        <div class="text-sm text-blue-800">
         <p class="font-semibold mb-1">Edit Data Karyawan:</p>
         <ul class="list-disc list-inside space-y-1 text-xs">
          <li>Cari data karyawan berdasarkan Nopek: <span id="editEmployeeNopek" class="font-bold">-</span></li>
          <li>Nama: <span id="editEmployeeName" class="font-bold">-</span></li>
          <li>Edit data langsung di spreadsheet yang ditampilkan</li>
          <li>Perubahan akan tersimpan otomatis</li>
          <li>Gunakan tombol "Refresh Data" untuk memperbarui tampilan</li>
         </ul>
        </div>
       </div>
      </div><!-- Spreadsheet Container -->
      <div class="bg-gray-50 rounded-xl p-4 mb-6">
       <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2"><span class="text-lg">ğŸ“Š</span> <span class="text-sm font-medium text-gray-700">Google Spreadsheet - Database Karyawan</span>
        </div>
        <div class="flex gap-2"><button onclick="refreshEditDataSpreadsheet()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm"> <span>ğŸ”„</span> Refresh Spreadsheet </button> <button onclick="refreshDataAfterEdit()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm"> <span>âœ…</span> Refresh Data </button>
        </div>
       </div><!-- Iframe Container -->
       <div class="bg-white rounded-lg shadow-inner"><iframe id="editDataFrame" src="https://docs.google.com/spreadsheets/d/1En78lujaSddXeQ3lXQNWTe48C-6GpQ2lvApxiuqccBQ/edit?usp=sharing" width="100%" height="600" frameborder="0" marginheight="0" marginwidth="0" class="rounded-lg"> Loading spreadsheet... </iframe>
       </div>
      </div><!-- Success Message -->
      <div id="editDataSuccessMessage" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
       <div class="flex items-center gap-3"><span class="text-green-600 text-lg">âœ…</span>
        <div class="text-sm text-green-800">
         <p class="font-semibold">Data karyawan berhasil diperbarui!</p>
         <p class="text-xs">Perubahan telah tersimpan ke database dan akan muncul di tabel setelah refresh.</p>
        </div>
       </div>
      </div><!-- Action Buttons -->
      <div class="border-t pt-4">
       <div class="flex gap-3 justify-center"><button onclick="closeEditDataModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-lg transition-colors"> Tutup </button> <button onclick="refreshDataAfterEdit(); closeEditDataModal();" class="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg transition-colors flex items-center gap-2"> <span>âœ…</span> Selesai &amp; Refresh Data </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Add New Account Modal -->
   <div id="addNewAccountModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">â•</span>
        <h3 class="text-2xl font-bold text-gray-900">Tambah Akun Baru</h3>
       </div><button onclick="closeAddNewAccount()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
       <div class="flex items-start gap-3"><span class="text-green-600 text-lg">â„¹ï¸</span>
        <div class="text-sm text-green-800">
         <p class="font-semibold mb-1">Petunjuk Tambah Akun Baru:</p>
         <ul class="list-disc list-inside space-y-1 text-xs">
          <li>Akses Google Spreadsheet untuk menambah akun baru secara langsung</li>
          <li>Tambahkan data akun di baris kosong berikutnya</li>
          <li>Pastikan Username unik dan tidak duplikat</li>
          <li>Isi semua kolom sesuai dengan format yang sudah ada</li>
          <li>Setelah input, gunakan tombol "Refresh User List" untuk memperbarui daftar</li>
         </ul>
        </div>
       </div>
      </div><!-- Form Container -->
      <div class="bg-gray-50 rounded-xl p-4 mb-6">
       <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2"><span class="text-lg">ğŸ“Š</span> <span class="text-sm font-medium text-gray-700">Google Spreadsheet - Database User Accounts</span>
        </div>
        <div class="flex gap-2"><button onclick="refreshUserAccountsForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm"> <span>ğŸ”„</span> Refresh Form </button> <button onclick="refreshUserListAfterAdd()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm"> <span>âœ…</span> Refresh User List </button>
        </div>
       </div><!-- Iframe Container -->
       <div class="bg-white rounded-lg shadow-inner"><iframe id="addNewAccountFrame" src="https://docs.google.com/spreadsheets/d/1vlDs1GdirtFGw2JhogShpNQICAPl5qHKM4HQmfntESA/edit?usp=sharing" width="100%" height="600" frameborder="0" marginheight="0" marginwidth="0" class="rounded-lg"> Loading spreadsheet... </iframe>
       </div>
      </div><!-- Success Message -->
      <div id="addAccountSuccessMessage" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
       <div class="flex items-center gap-3"><span class="text-green-600 text-lg">âœ…</span>
        <div class="text-sm text-green-800">
         <p class="font-semibold">Akun baru berhasil ditambahkan!</p>
         <p class="text-xs">Data akun telah tersimpan ke database dan akan muncul di daftar user setelah refresh.</p>
        </div>
       </div>
      </div><!-- Action Buttons -->
      <div class="border-t pt-4">
       <div class="flex gap-3 justify-center"><button onclick="closeAddNewAccount()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-lg transition-colors"> Tutup </button> <button onclick="refreshUserListAfterAdd(); closeAddNewAccount();" class="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg transition-colors flex items-center gap-2"> <span>âœ…</span> Selesai &amp; Refresh User List </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- About Modal -->
   <div id="aboutModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">â„¹ï¸</span>
        <h3 class="text-2xl font-bold text-gray-900">Tentang Sistem</h3>
       </div><button onclick="closeAbout()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="text-center mb-6">
       <div class="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center"><span class="text-3xl text-white">ğŸ¢</span>
       </div>
       <h4 class="text-xl font-bold text-gray-900">Sistem Manajemen Data Karyawan</h4>
       <p class="text-gray-600">PT PERTAMINA DRILLING</p>
      </div>
      <div class="space-y-4">
       <div class="bg-gray-50 rounded-lg p-4">
        <div class="grid grid-cols-2 gap-4 text-sm">
         <div>
          <p class="font-medium text-gray-700">Versi Sistem:</p>
          <p class="text-gray-900">v2.1.0</p>
         </div>
         <div>
          <p class="font-medium text-gray-700">Tanggal Rilis:</p>
          <p class="text-gray-900">20 Desember 2024</p>
         </div>
         <div>
          <p class="font-medium text-gray-700">Developer:</p>
          <p class="text-gray-900">IT Department</p>
         </div>
         <div>
          <p class="font-medium text-gray-700">Status:</p>
          <p class="text-green-600 font-medium">ğŸŸ¢ Aktif</p>
         </div>
        </div>
       </div>
       <div class="bg-blue-50 rounded-lg p-4">
        <h5 class="font-semibold text-blue-800 mb-2">Fitur Utama:</h5>
        <ul class="text-sm text-blue-700 space-y-1">
         <li>â€¢ Manajemen data karyawan lengkap</li>
         <li>â€¢ Upload dan manajemen foto karyawan</li>
         <li>â€¢ Sistem pelaporan terintegrasi</li>
         <li>â€¢ Dashboard analytics real-time</li>
         <li>â€¢ Backup &amp; restore data otomatis</li>
         <li>â€¢ Validasi data dan audit trail</li>
        </ul>
       </div>
       <div class="bg-green-50 rounded-lg p-4">
        <h5 class="font-semibold text-green-800 mb-2">Teknologi:</h5>
        <div class="flex flex-wrap gap-2"><span class="bg-white px-2 py-1 rounded text-xs font-medium">HTML5</span> <span class="bg-white px-2 py-1 rounded text-xs font-medium">CSS3</span> <span class="bg-white px-2 py-1 rounded text-xs font-medium">JavaScript</span> <span class="bg-white px-2 py-1 rounded text-xs font-medium">Tailwind CSS</span> <span class="bg-white px-2 py-1 rounded text-xs font-medium">Google Sheets API</span>
        </div>
       </div>
      </div>
      <div class="border-t pt-4 mt-6">
       <div class="flex gap-3"><button onclick="closeAbout()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-lg transition-colors"> Tutup </button> <button onclick="checkUpdates()" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center gap-2"> <span>ğŸ”„</span> Cek Update </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Print Laporan Modal -->
   <div id="printLaporanModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <div class="flex items-center gap-3"><span class="text-2xl">ğŸ–¨ï¸</span>
        <h3 class="text-2xl font-bold text-gray-900">Print Laporan</h3>
       </div><button onclick="closePrintLaporan()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
       <div class="flex items-center gap-3"><span class="text-purple-600 text-lg">ğŸ–¨ï¸</span>
        <div class="text-sm text-purple-800">
         <p class="font-semibold">Cetak Laporan</p>
         <p class="text-xs">Pilih jenis laporan dan periode yang ingin dicetak</p>
        </div>
       </div>
      </div><!-- Print Options -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
       <div class="bg-gray-50 rounded-lg p-4">
        <h4 class="font-semibold text-gray-800 mb-3">Jenis Laporan</h4>
        <div class="space-y-2"><label class="flex items-center gap-2"> <input type="radio" name="reportType" value="daily" class="text-purple-600"> <span class="text-sm">Laporan Harian</span> </label> <label class="flex items-center gap-2"> <input type="radio" name="reportType" value="weekly" class="text-purple-600"> <span class="text-sm">Laporan Mingguan</span> </label> <label class="flex items-center gap-2"> <input type="radio" name="reportType" value="monthly" class="text-purple-600" checked> <span class="text-sm">Laporan Bulanan</span> </label> <label class="flex items-center gap-2"> <input type="radio" name="reportType" value="yearly" class="text-purple-600"> <span class="text-sm">Laporan Tahunan</span> </label>
        </div>
       </div>
       <div class="bg-gray-50 rounded-lg p-4">
        <h4 class="font-semibold text-gray-800 mb-3">Periode</h4>
        <div class="space-y-3">
         <div><label class="block text-sm font-medium text-gray-700 mb-1">Dari Tanggal</label> <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-1">Sampai Tanggal</label> <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
         </div>
        </div>
       </div>
      </div><!-- Print Preview -->
      <div class="bg-gray-50 rounded-xl p-6 mb-6">
       <div class="text-center mb-4">
        <div class="text-4xl mb-3">
         ğŸ“„
        </div>
        <h4 class="text-lg font-semibold text-gray-700 mb-2">Preview Laporan</h4>
        <p class="text-gray-600 mb-4">Preview format tabel laporan yang akan dicetak</p>
       </div><!-- Print Preview Table -->
       <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200">
        <div class="bg-gray-800 text-white p-4 text-center">
         <h3 class="text-lg font-bold">PT PERTAMINA DRILLING</h3>
         <p class="text-sm text-gray-300">Laporan Aktivitas Operasional</p>
         <p class="text-xs text-gray-400 mt-1">Periode: <span id="previewPeriod">Akan disesuaikan dengan filter</span></p>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full text-xs">
          <thead class="bg-gray-600 text-white">
           <tr>
            <th class="px-2 py-2 text-left font-semibold">Tanggal</th>
            <th class="px-2 py-2 text-left font-semibold">Rig PDSI</th>
            <th class="px-2 py-2 text-left font-semibold">Lokasi</th>
            <th class="px-2 py-2 text-left font-semibold">Status</th>
            <th class="px-2 py-2 text-left font-semibold">Personel In Charge</th>
            <th class="px-2 py-2 text-left font-semibold">Aktivitas Pekerja</th>
           </tr>
          </thead>
          <tbody class="divide-y divide-gray-200" id="printPreviewBody">
           <tr class="bg-white">
            <td class="px-2 py-2 text-gray-600">2024-12-01</td>
            <td class="px-2 py-2 font-medium">RIG-001</td>
            <td class="px-2 py-2">Lokasi A</td>
            <td class="px-2 py-2"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"> Operasi </span></td>
            <td class="px-2 py-2">John Doe</td>
            <td class="px-2 py-2">Drilling operations</td>
           </tr>
           <tr class="bg-gray-50">
            <td class="px-2 py-2 text-gray-600">2024-12-02</td>
            <td class="px-2 py-2 font-medium">RIG-002</td>
            <td class="px-2 py-2">Lokasi B</td>
            <td class="px-2 py-2"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"> Maintenance </span></td>
            <td class="px-2 py-2">Jane Smith</td>
            <td class="px-2 py-2">Equipment maintenance</td>
           </tr>
           <tr class="bg-white">
            <td class="px-2 py-2 text-gray-600">2024-12-03</td>
            <td class="px-2 py-2 font-medium">RIG-003</td>
            <td class="px-2 py-2">Lokasi C</td>
            <td class="px-2 py-2"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800"> Standby </span></td>
            <td class="px-2 py-2">Mike Johnson</td>
            <td class="px-2 py-2">Standby operations</td>
           </tr>
          </tbody>
         </table>
        </div>
        <div class="bg-gray-100 p-3 text-xs text-gray-600">
         <div class="flex justify-between items-center"><span>Total Records: <strong id="previewTotalRecords">3</strong></span> <span>Generated: <strong id="previewGeneratedDate">{tanggal_cetak}</strong></span>
         </div>
        </div>
       </div>
       <div class="mt-4 text-center">
        <p class="text-xs text-gray-500">* Data di atas adalah contoh format. Data aktual akan disesuaikan dengan filter yang dipilih.</p>
       </div>
      </div>
      <div class="border-t pt-4">
       <div class="flex gap-3"><button onclick="closePrintLaporan()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-lg transition-colors"> Tutup </button> <button onclick="generatePrintPreview()" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center gap-2"> <span>ğŸ‘ï¸</span> Preview </button> <button onclick="printReport()" class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center gap-2"> <span>ğŸ–¨ï¸</span> Cetak Laporan </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Photo Upload Modal -->
   <div id="photoUploadModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-4">
       <h3 class="text-xl font-bold text-gray-900">Upload Foto Karyawan</h3><button onclick="closePhotoUpload()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
      </div>
      <div class="mb-4">
       <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
        <div class="flex items-center gap-2 text-blue-800"><span class="text-lg">ğŸ‘¤</span>
         <div>
          <p class="font-semibold" id="modalEmployeeName">-</p>
          <p class="text-sm text-blue-600">Nopek: <span id="modalEmployeeNopek">-</span></p>
         </div>
        </div>
       </div>
      </div><!-- Photo Upload Form -->
      <form id="photoUploadForm" class="space-y-4">
       <div class="text-center">
        <div id="photoPreview" class="w-32 h-32 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-4 overflow-hidden"><span class="text-4xl text-gray-400">ğŸ“·</span>
        </div>
       </div>
       <div class="space-y-4"><!-- File Input -->
        <div><label for="photoFile" class="block text-sm font-medium text-gray-700 mb-2"> Pilih Foto Karyawan </label> <input type="file" id="photoFile" name="photo" accept="image/jpeg,image/jpg,image/png" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
         <p class="text-xs text-gray-500 mt-1">Format: JPG, PNG (maksimal 2MB)</p>
        </div><!-- Employee Details -->
        <div class="grid grid-cols-2 gap-4">
         <div><label for="employeeNopek" class="block text-sm font-medium text-gray-700 mb-2"> Nopek </label> <input type="text" id="employeeNopek" name="nopek" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
         </div>
         <div><label for="employeeName" class="block text-sm font-medium text-gray-700 mb-2"> Nama Lengkap </label> <input type="text" id="employeeName" name="name" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
         </div>
        </div><!-- Upload Date -->
        <div><label for="uploadDate" class="block text-sm font-medium text-gray-700 mb-2"> Tanggal Upload </label> <input type="date" id="uploadDate" name="uploadDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div><!-- Notes -->
        <div><label for="uploadNotes" class="block text-sm font-medium text-gray-700 mb-2"> Catatan (Opsional) </label> <textarea id="uploadNotes" name="notes" rows="3" placeholder="Tambahkan catatan jika diperlukan..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
        </div>
       </div>
       <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
        <div class="flex items-start gap-3"><span class="text-amber-600 text-lg">âš ï¸</span>
         <div class="text-sm text-amber-800">
          <p class="font-semibold mb-1">Petunjuk Upload Foto:</p>
          <ul class="list-disc list-inside space-y-1 text-xs">
           <li>Gunakan foto formal dengan latar belakang putih</li>
           <li>Format file: JPG, PNG (maksimal 2MB)</li>
           <li>Ukuran foto: 3x4 cm atau 4x6 cm</li>
           <li>Pastikan wajah terlihat jelas</li>
          </ul>
         </div>
        </div>
       </div><!-- Success/Error Messages -->
       <div id="uploadMessage" class="hidden"></div>
       <div class="border-t pt-4">
        <div class="flex gap-3"><button type="button" onclick="closePhotoUpload()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-colors"> Batal </button> <button type="submit" id="uploadBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"> <span>ğŸ“·</span> Upload Foto </button>
        </div>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Footer -->
   <footer class="bg-gradient-to-r from-slate-800 via-gray-800 to-slate-900 text-white py-8 mt-12 border-t-4 border-gradient-to-r from-blue-500 to-indigo-500">
    <div class="container mx-auto px-4">
     <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <div>
       <div class="flex items-start space-x-3 mb-4"><img src="https://p1.hiclipart.com/preview/745/129/287/graphic-background-logo-line-pertamina-text-area-png-clipart.jpg" alt="Logo PT Pertamina Drilling" class="h-10 w-auto object-contain drop-shadow-lg flex-shrink-0" onerror="this.style.display='none';">
        <div class="flex-1">
         <h3 class="text-xl font-bold text-white drop-shadow-lg">PT PERTAMINA DRILLING</h3>
         <p id="footerDescription" class="text-blue-200 text-sm mt-1">Sistem Manajemen Data Karyawan yang modern dan efisien untuk mengelola informasi kepegawaian perusahaan.</p>
        </div>
       </div>
      </div>
      <div>
       <h4 class="text-lg font-semibold mb-4 text-white">Menu</h4>
       <ul class="space-y-2 text-blue-200">
        <li><a href="#" onclick="showDashboard()" class="hover:text-white transition-all duration-300 hover:translate-x-1">ğŸ“Š Dashboard</a></li>
        <li><a href="#" onclick="showDataKaryawan('')" class="hover:text-white transition-all duration-300 hover:translate-x-1">ğŸ‘¥ Data Karyawan</a></li>
        <li><a href="#" class="hover:text-white transition-all duration-300 hover:translate-x-1">ğŸ“Š Laporan</a></li>
        <li><a href="#" class="hover:text-white transition-all duration-300 hover:translate-x-1">âš™ï¸ Pengaturan</a></li>
       </ul>
      </div>
      <div>
       <h4 class="text-lg font-semibold mb-4 text-white">Kontak</h4>
       <div class="text-blue-200 space-y-2">
        <p class="hover:text-white transition-colors duration-300">ğŸ“§ info@pertamina.com</p>
        <p class="hover:text-white transition-colors duration-300">ğŸ“ +62 713 326800</p>
        <p class="hover:text-white transition-colors duration-300">ğŸ“ Jakarta, Indonesia</p>
       </div>
      </div>
     </div>
     <div class="border-t border-blue-800 border-opacity-50 mt-8 pt-4 text-center text-blue-200">
      <p>Â© 2024 PT PERTAMINA DRILLING. Semua hak dilindungi.</p>
     </div>
    </div>
   </footer>
   <script>
        // Authentication System
        let currentUser = null;
        let userRole = null;
        
        // User accounts database (loaded from Google Sheets)
        let userAccounts = {};
        
        // Load user accounts from Google Sheets
        async function loadUserAccounts() {
            try {
                console.log('Loading user accounts from Google Sheets...');
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRrFjdh74ULdATEGY3jhtwHmQh4681jhr-hx_VLDjXUDAAOZe4km_s42CG7sgJm1sqgjDPK9_k2U8gl/pub?gid=0&single=true&output=csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('User accounts CSV data received, length:', csvText.length);
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('Empty CSV data received for user accounts');
                }
                
                // Parse CSV
                const lines = csvText.split('\n').filter(line => line.trim());
                console.log('Total user account lines:', lines.length);
                
                if (lines.length < 2) {
                    throw new Error('User accounts CSV data appears to be empty or invalid');
                }
                
                const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
                console.log('User account headers found:', headers);
                
                userAccounts = {};
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = parseCSVLine(lines[i]);
                        const user = {};
                        headers.forEach((header, index) => {
                            user[header] = (values[index] || '').trim().replace(/"/g, '');
                        });
                        
                        // Map the user data to our account structure
                        const username = user.Username || user.username || user.USER;
                        const password = user.Password || user.password || user.PASS;
                        const role = user.Role || user.role || user.ROLE;
                        const name = user.Name || user.name || user.NAMA || user['Nama Lengkap'];
                        const nopek = user.Nopek || user.nopek || user.NOPEK || user['Employee ID'];
                        
                        if (username && password && role && name) {
                            // Determine permissions based on role
                            let permissions = [];
                            if (role.toLowerCase() === 'admin') {
                                permissions = ['read', 'write', 'delete', 'admin'];
                            } else if (role.toLowerCase() === 'staff') {
                                permissions = ['read', 'write'];
                            } else if (role.toLowerCase() === 'viewer') {
                                permissions = ['read'];
                            } else {
                                permissions = ['read']; // Default to read-only
                            }
                            
                            userAccounts[username] = {
                                password: password,
                                role: role.toLowerCase(),
                                name: name,
                                nopek: nopek || null,
                                permissions: permissions,
                                department: user.Department || user.Departemen || null,
                                position: user.Position || user.Jabatan || null,
                                email: user.Email || user.email || null
                            };
                        }
                    }
                }
                
                console.log('User accounts loaded:', Object.keys(userAccounts));
                console.log('User accounts data:', userAccounts);
                
                // If no accounts loaded, show error
                if (Object.keys(userAccounts).length === 0) {
                    console.error('No user accounts loaded from database');
                    throw new Error('Database user accounts tidak dapat dimuat. Silakan hubungi administrator.');
                }
                
                return userAccounts;
                
            } catch (error) {
                console.error('Error loading user accounts:', error);
                
                // Show error to user - no fallback accounts
                showLoginError('Gagal memuat database akun pengguna. Silakan hubungi administrator sistem.');
                
                // Return empty accounts object
                userAccounts = {};
                return userAccounts;
            }
        }

        // Login Functions
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginError = document.getElementById('loginError');
            
            // Show loading state
            loginButton.disabled = true;
            loginButtonText.innerHTML = '<div class="loading"></div> Memverifikasi...';
            
            // Hide previous error
            loginError.classList.add('hidden');
            
            // Update login subtitle based on user role before authentication
            if (userAccounts[username]) {
                updateLoginSubtitle(userAccounts[username].role);
            }
            
            // Simulate authentication delay
            setTimeout(() => {
                if (authenticateUser(username, password)) {
                    // Successful login
                    currentUser = username;
                    userRole = userAccounts[username].role;
                    
                    // Store session
                    sessionStorage.setItem('currentUser', username);
                    sessionStorage.setItem('userRole', userRole);
                    sessionStorage.setItem('loginTime', new Date().toISOString());
                    
                    // Update UI
                    updateUserInterface();
                    showMainApplication();
                    
                    showNotification(`âœ… Selamat datang, ${userAccounts[username].name}!`, 'success');
                } else {
                    // Failed login - reset subtitle to default
                    updateLoginSubtitle('default');
                    showLoginError('Username atau password salah!');
                }
                
                // Reset button
                loginButton.disabled = false;
                loginButtonText.textContent = 'ğŸ” Masuk';
            }, 1500);
        }

        // Update login subtitle based on role
        function updateLoginSubtitle(role) {
            const subtitle = document.getElementById('loginSubtitle');
            if (!subtitle) return;
            
            const normalizedRole = role ? role.toLowerCase() : 'default';
            
            if (normalizedRole === 'staff') {
                subtitle.textContent = 'Sistem Manajemen Laporan Kerja';
            } else {
                subtitle.textContent = 'Sistem Manajemen Data Karyawan';
            }
        }

        // Update footer description based on role
        function updateFooterDescription(role) {
            const footerDescription = document.getElementById('footerDescription');
            if (!footerDescription) return;
            
            const normalizedRole = role ? role.toLowerCase() : 'default';
            
            if (normalizedRole === 'staff') {
                footerDescription.textContent = 'Sistem Manajemen laporan operasional yang modern dan efisien untuk mengelola data informasi kegiatan perusahaan.';
            } else {
                footerDescription.textContent = 'Sistem Manajemen Data Karyawan yang modern dan efisien untuk mengelola informasi kepegawaian perusahaan.';
            }
        }

        function authenticateUser(username, password) {
            const user = userAccounts[username];
            return user && user.password === password;
        }

        function showLoginError(message) {
            const loginError = document.getElementById('loginError');
            const loginErrorMessage = document.getElementById('loginErrorMessage');
            
            loginErrorMessage.textContent = message;
            loginError.classList.remove('hidden');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                loginError.classList.add('hidden');
            }, 5000);
        }

        function quickLogin(username, password) {
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
            
            // Trigger login
            const loginForm = document.getElementById('loginForm');
            loginForm.dispatchEvent(new Event('submit'));
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.textContent = 'ğŸ™ˆ';
            } else {
                passwordInput.type = 'password';
                toggleIcon.textContent = 'ğŸ‘ï¸';
            }
        }

        function showForgotPassword() {
            showNotification('ğŸ“§ Hubungi administrator untuk reset password', 'info');
        }

        function showMainApplication() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApplication').classList.remove('hidden');
            
            // Initialize main application
            initializePage();
        }

        function updateUserInterface() {
            const user = userAccounts[currentUser];
            
            // Update user info bar
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserRole').textContent = `(${user.role.toUpperCase()})`;
            
            const loginTime = new Date().toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('loginTime').textContent = `Login: ${loginTime}`;
            
            // Update footer description based on role
            updateFooterDescription(user.role);
            
            // Apply role-based permissions
            applyRolePermissions(user.role);
        }

        function applyRolePermissions(role) {
            // Hide/show menu items based on role
            const inputDataKaryawanBtn = document.getElementById('inputDataKaryawanBtn');
            const inputLaporanBtn = document.getElementById('inputLaporanBtn');
            const printLaporanBtn = document.getElementById('printLaporanBtn');
            const pengaturanMenu = document.getElementById('pengaturanMenu');
            const dataKaryawanMenu = document.getElementById('dataKaryawanMenu');
            const dashboardBtn = document.querySelector('button[onclick="showDashboard()"]');
            const floatingHeader = document.querySelector('.floating-header');
            
            // Normalize role to lowercase for comparison
            const normalizedRole = role.toLowerCase();
            
            if (normalizedRole === 'viewer') {
                // Viewer: Read-only access
                if (inputDataKaryawanBtn) inputDataKaryawanBtn.style.display = 'none';
                if (inputLaporanBtn) inputLaporanBtn.style.display = 'none';
                if (printLaporanBtn) printLaporanBtn.style.display = 'none';
                if (pengaturanMenu) pengaturanMenu.style.display = 'none';
                if (dataKaryawanMenu) dataKaryawanMenu.style.display = 'none';
                if (dashboardBtn) dashboardBtn.style.display = 'none';
                
                // Update user info bar color for viewer
                document.getElementById('userInfoBar').className = 'bg-gradient-to-r from-purple-600 to-violet-600 text-white py-2 px-4 shadow-lg';
                
            } else if (normalizedRole === 'staff') {
                // Staff: Only Laporan menu access
                if (inputDataKaryawanBtn) inputDataKaryawanBtn.style.display = 'none';
                if (inputLaporanBtn) inputLaporanBtn.style.display = 'block';
                if (printLaporanBtn) printLaporanBtn.style.display = 'block';
                if (pengaturanMenu) pengaturanMenu.style.display = 'none';
                if (dataKaryawanMenu) dataKaryawanMenu.style.display = 'none';
                if (dashboardBtn) dashboardBtn.style.display = 'none';
                
                // Hide scrolling text for staff role
                if (floatingHeader) floatingHeader.style.display = 'none';
                
                // Update user info bar color for staff
                document.getElementById('userInfoBar').className = 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-2 px-4 shadow-lg';
                
                // Show notification about restricted access for staff
                setTimeout(() => {
                    showNotification(`ğŸ‘¤ Mode ${role.toUpperCase()}: Anda hanya memiliki akses ke menu Laporan`, 'info');
                }, 2000);
                
            } else if (normalizedRole === 'admin' || normalizedRole === 'administrator') {
                // Admin/Administrator: Full access
                if (inputDataKaryawanBtn) inputDataKaryawanBtn.style.display = 'block';
                if (inputLaporanBtn) inputLaporanBtn.style.display = 'block';
                if (printLaporanBtn) printLaporanBtn.style.display = 'block';
                if (pengaturanMenu) pengaturanMenu.style.display = 'block';
                if (dataKaryawanMenu) dataKaryawanMenu.style.display = 'block';
                if (dashboardBtn) dashboardBtn.style.display = 'block';
                
                // Show scrolling text for admin/administrator role
                if (floatingHeader) floatingHeader.style.display = 'block';
                
                // Update user info bar color for admin
                document.getElementById('userInfoBar').className = 'bg-gradient-to-r from-red-600 to-pink-600 text-white py-2 px-4 shadow-lg';
                
                // Show notification for admin access
                setTimeout(() => {
                    showNotification(`ğŸ‘‘ Mode ${role.toUpperCase()}: Anda memiliki akses penuh ke semua fitur`, 'success');
                }, 2000);
            } else {
                // Default: Limited access for unknown roles
                if (inputDataKaryawanBtn) inputDataKaryawanBtn.style.display = 'none';
                if (inputLaporanBtn) inputLaporanBtn.style.display = 'block';
                if (printLaporanBtn) printLaporanBtn.style.display = 'block';
                if (pengaturanMenu) pengaturanMenu.style.display = 'none';
                if (dataKaryawanMenu) dataKaryawanMenu.style.display = 'none';
                if (dashboardBtn) dashboardBtn.style.display = 'none';
                
                // Hide scrolling text for unknown roles
                if (floatingHeader) floatingHeader.style.display = 'none';
                
                // Update user info bar color for unknown role
                document.getElementById('userInfoBar').className = 'bg-gradient-to-r from-gray-600 to-slate-600 text-white py-2 px-4 shadow-lg';
                
                console.warn('Unknown role detected:', role);
                showNotification(`âš ï¸ Role "${role}" tidak dikenali. Menggunakan akses terbatas.`, 'info');
            }
            
            // Store role-based restrictions globally
            window.userPermissions = userAccounts[currentUser].permissions;
        }

        function hasPermission(permission) {
            return window.userPermissions && window.userPermissions.includes(permission);
        }

        function checkPermission(permission, action = 'aksi ini') {
            if (!hasPermission(permission)) {
                showNotification(`âŒ Anda tidak memiliki izin untuk ${action}`, 'error');
                return false;
            }
            return true;
        }

        function logout() {
            // Clear session
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('userRole');
            sessionStorage.removeItem('loginTime');
            
            // Reset variables
            currentUser = null;
            userRole = null;
            window.userPermissions = null;
            
            // Show login page
            document.getElementById('mainApplication').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            
            // Reset login form
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
            
            showNotification('ğŸ‘‹ Anda telah logout. Terima kasih!', 'info');
        }

        // Check for existing session on page load
        function checkExistingSession() {
            const storedUser = sessionStorage.getItem('currentUser');
            const storedRole = sessionStorage.getItem('userRole');
            
            if (storedUser && storedRole && userAccounts[storedUser]) {
                currentUser = storedUser;
                userRole = storedRole;
                
                // Update footer description based on stored role
                updateFooterDescription(storedRole);
                
                updateUserInterface();
                showMainApplication();
                
                showNotification(`ğŸ‘‹ Selamat datang kembali, ${userAccounts[storedUser].name}!`, 'success');
                return true;
            }
            return false;
        }



        // Enhanced functions with permission checks
        function openInputDataKaryawan() {
            if (!checkPermission('write', 'menambah data karyawan')) return;
            
            document.getElementById('inputDataKaryawanModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ‘¥ Membuka form input data karyawan', 'info');
            
            // Hide success message when opening
            document.getElementById('dataKaryawanSuccessMessage').classList.add('hidden');
        }

        function openInputLaporan() {
            if (!checkPermission('write', 'membuat laporan')) return;
            
            document.getElementById('inputLaporanModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ“ Membuka form input laporan', 'info');
        }

        function openPrintLaporan() {
            if (!checkPermission('write', 'mencetak laporan')) return;
            
            document.getElementById('printLaporanModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ–¨ï¸ Membuka menu print laporan', 'info');
        }

        function openBackupRestore() {
            if (!checkPermission('admin', 'mengakses backup & restore')) return;
            
            document.getElementById('backupRestoreModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ’¾ Membuka menu backup & restore', 'info');
        }

        function openUserManagement() {
            if (!checkPermission('admin', 'mengelola user')) return;
            
            document.getElementById('userManagementModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ‘¥ Membuka manajemen user', 'info');
            
            // Load user list
            loadUserList();
        }

        function closeUserManagement() {
            document.getElementById('userManagementModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function openResetPassword() {
            if (!checkPermission('admin', 'reset password')) return;
            
            document.getElementById('resetPasswordModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ”‘ Membuka form reset password', 'info');
            
            // Populate user select dropdown
            populateResetUserSelect();
        }

        function closeResetPassword() {
            document.getElementById('resetPasswordModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset form
            document.getElementById('resetPasswordForm').reset();
            document.getElementById('selectedUserInfo').classList.add('hidden');
            document.getElementById('resetPasswordMessage').classList.add('hidden');
        }

        function openAddNewAccount() {
            if (!checkPermission('admin', 'menambah akun baru')) return;
            
            document.getElementById('addNewAccountModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('â• Membuka form tambah akun baru', 'info');
            
            // Hide success message when opening
            document.getElementById('addAccountSuccessMessage').classList.add('hidden');
        }

        function closeAddNewAccount() {
            document.getElementById('addNewAccountModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Load and display user list
        async function loadUserList() {
            const tableBody = document.getElementById('userListTableBody');
            
            try {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">ğŸ”„ Memuat daftar user...</td></tr>';
                
                // Load user accounts from the new database
                try {
                    const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRrFjdh74ULdATEGY3jhtwHmQh4681jhr-hx_VLDjXUDAAOZe4km_s42CG7sgJm1sqgjDPK9_k2U8gl/pub?gid=0&single=true&output=csv');
                    
                    if (response.ok) {
                        const csvText = await response.text();
                        
                        if (csvText && csvText.trim().length > 0) {
                            const lines = csvText.split('\n').filter(line => line.trim());
                            
                            if (lines.length > 1) {
                                const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
                                
                                userAccounts = {};
                                for (let i = 1; i < lines.length; i++) {
                                    if (lines[i].trim()) {
                                        const values = parseCSVLine(lines[i]);
                                        const user = {};
                                        headers.forEach((header, index) => {
                                            user[header] = (values[index] || '').trim().replace(/"/g, '');
                                        });
                                        
                                        const username = user.Username || user.username || user.USER;
                                        const password = user.Password || user.password || user.PASS;
                                        const role = user.Role || user.role || user.ROLE;
                                        const name = user.Name || user.name || user.NAMA || user['Nama Lengkap'];
                                        
                                        if (username && password && role && name) {
                                            let permissions = [];
                                            if (role.toLowerCase() === 'admin') {
                                                permissions = ['read', 'write', 'delete', 'admin'];
                                            } else if (role.toLowerCase() === 'staff') {
                                                permissions = ['read', 'write'];
                                            } else if (role.toLowerCase() === 'viewer') {
                                                permissions = ['read'];
                                            } else {
                                                permissions = ['read'];
                                            }
                                            
                                            userAccounts[username] = {
                                                password: password,
                                                role: role.toLowerCase(),
                                                name: name,
                                                nopek: user.Nopek || user.nopek || null,
                                                permissions: permissions,
                                                department: user.Department || user.Departemen || null,
                                                position: user.Position || user.Jabatan || null,
                                                email: user.Email || user.email || null
                                            };
                                        }
                                    }
                                }
                            }
                        }
                    }
                } catch (fetchError) {
                    console.log('Could not load from new database, using existing accounts:', fetchError.message);
                }
                
                if (Object.keys(userAccounts).length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">ğŸ“­ Tidak ada user yang ditemukan</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = Object.keys(userAccounts).map((username, index) => {
                    const user = userAccounts[username];
                    return `
                        <tr class="hover:bg-gray-50 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-25'}">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${username}</td>
                            <td class="px-4 py-3 text-sm">${user.name || '-'}</td>
                            <td class="px-4 py-3 text-sm">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getRoleColor(user.role)}">
                                    ${user.role.toUpperCase()}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm">${user.department || '-'}</td>
                            <td class="px-4 py-3 text-sm">${user.email || '-'}</td>
                            <td class="px-4 py-3 text-sm">
                                <div class="flex gap-2">
                                    <button onclick="resetUserPassword('${username}')" 
                                            class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs transition-colors">
                                        ğŸ”‘ Reset
                                    </button>
                                    ${username !== currentUser ? 
                                        `<button onclick="deleteUser('${username}')" 
                                                class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs transition-colors">
                                            ğŸ—‘ï¸ Hapus
                                        </button>` : 
                                        '<span class="text-xs text-gray-500">Current User</span>'
                                    }
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                showNotification(`âœ… Berhasil memuat ${Object.keys(userAccounts).length} user`, 'success');
                
            } catch (error) {
                console.error('Error loading user list:', error);
                tableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-600">âŒ Gagal memuat daftar user</td></tr>';
                showNotification('âŒ Gagal memuat daftar user', 'error');
            }
        }

        // Get role color for badges
        function getRoleColor(role) {
            switch (role.toLowerCase()) {
                case 'admin':
                    return 'bg-red-100 text-red-800';
                case 'staff':
                    return 'bg-blue-100 text-blue-800';
                case 'viewer':
                    return 'bg-purple-100 text-purple-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Populate reset user select dropdown
        function populateResetUserSelect() {
            const select = document.getElementById('resetUserSelect');
            select.innerHTML = '<option value="">-- Pilih User --</option>';
            
            Object.keys(userAccounts).forEach(username => {
                const user = userAccounts[username];
                select.innerHTML += `<option value="${username}">${user.name} (${username}) - ${user.role.toUpperCase()}</option>`;
            });
            
            // Add event listener for user selection
            select.addEventListener('change', function() {
                const selectedUsername = this.value;
                const userInfo = document.getElementById('selectedUserInfo');
                
                if (selectedUsername && userAccounts[selectedUsername]) {
                    const user = userAccounts[selectedUsername];
                    document.getElementById('selectedUserName').textContent = user.name;
                    document.getElementById('selectedUserRole').textContent = user.role.toUpperCase();
                    userInfo.classList.remove('hidden');
                } else {
                    userInfo.classList.add('hidden');
                }
            });
        }

        // Toggle new password visibility
        function toggleNewPassword() {
            const passwordInput = document.getElementById('newPassword');
            const toggleIcon = document.getElementById('newPasswordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.textContent = 'ğŸ™ˆ';
            } else {
                passwordInput.type = 'password';
                toggleIcon.textContent = 'ğŸ‘ï¸';
            }
        }

        // Handle reset password form submission
        function handleResetPassword(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const username = formData.get('username');
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            const resetBtn = document.getElementById('resetPasswordBtn');
            const messageDiv = document.getElementById('resetPasswordMessage');
            
            // Validate inputs
            if (!username) {
                showResetPasswordMessage('âŒ Silakan pilih user terlebih dahulu', 'error');
                return;
            }
            
            if (!newPassword || newPassword.length < 6) {
                showResetPasswordMessage('âŒ Password baru minimal 6 karakter', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showResetPasswordMessage('âŒ Konfirmasi password tidak cocok', 'error');
                return;
            }
            
            // Show loading state
            resetBtn.disabled = true;
            resetBtn.innerHTML = '<div class="loading"></div> Mereset password...';
            
            // Simulate password reset process
            setTimeout(async () => {
                try {
                    // Update password in userAccounts
                    if (userAccounts[username]) {
                        userAccounts[username].password = newPassword;
                        
                        // In a real application, you would send this to the Google Sheets database
                        // For now, we'll simulate the update and show success
                        
                        // Store the password change in localStorage for persistence
                        const passwordChanges = JSON.parse(localStorage.getItem('passwordChanges') || '{}');
                        passwordChanges[username] = {
                            newPassword: newPassword,
                            changedAt: new Date().toISOString(),
                            changedBy: currentUser
                        };
                        localStorage.setItem('passwordChanges', JSON.stringify(passwordChanges));
                        
                        showResetPasswordMessage(`âœ… Password untuk ${userAccounts[username].name} berhasil direset!`, 'success');
                        showNotification(`ğŸ”‘ Password ${username} berhasil direset dan disimpan ke database`, 'success');
                        
                        // Reset form after 2 seconds
                        setTimeout(() => {
                            closeResetPassword();
                        }, 2000);
                        
                    } else {
                        throw new Error('User tidak ditemukan');
                    }
                } catch (error) {
                    showResetPasswordMessage('âŒ Gagal mereset password: ' + error.message, 'error');
                }
                
                // Reset button
                resetBtn.disabled = false;
                resetBtn.innerHTML = '<span>ğŸ”‘</span> Reset Password';
            }, 2000);
        }

        // Show reset password message
        function showResetPasswordMessage(message, type) {
            const messageDiv = document.getElementById('resetPasswordMessage');
            messageDiv.classList.remove('hidden');
            
            if (type === 'success') {
                messageDiv.className = 'bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg';
            } else if (type === 'error') {
                messageDiv.className = 'bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg';
            }
            
            messageDiv.innerHTML = `<div class="flex items-center gap-2"><span>${message}</span></div>`;
            
            // Auto hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Quick reset password from user list
        function resetUserPassword(username) {
            closeUserManagement();
            openResetPassword();
            
            // Pre-select the user
            setTimeout(() => {
                const select = document.getElementById('resetUserSelect');
                select.value = username;
                select.dispatchEvent(new Event('change'));
            }, 100);
        }

        // Delete user (placeholder function)
        function deleteUser(username) {
            if (username === currentUser) {
                showNotification('âŒ Tidak dapat menghapus akun yang sedang digunakan', 'error');
                return;
            }
            
            const user = userAccounts[username];
            if (confirm(`Apakah Anda yakin ingin menghapus user "${user.name}" (${username})?`)) {
                // In a real application, you would send delete request to server
                // For demo purposes, we'll just remove from local data
                delete userAccounts[username];
                loadUserList(); // Refresh the list
                showNotification(`ğŸ—‘ï¸ User ${username} berhasil dihapus`, 'success');
            }
        }

        // Refresh user list
        function refreshUserList() {
            showNotification('ğŸ”„ Memperbarui daftar user...', 'info');
            loadUserList();
        }

        // Refresh user accounts form
        function refreshUserAccountsForm() {
            const iframe = document.getElementById('addNewAccountFrame');
            iframe.src = 'https://docs.google.com/spreadsheets/d/1vlDs1GdirtFGw2JhogShpNQICAPl5qHKM4HQmfntESA/edit?usp=sharing';
            showNotification('ğŸ”„ Spreadsheet user accounts berhasil di-refresh', 'success');
            
            // Hide success message when refreshing
            document.getElementById('addAccountSuccessMessage').classList.add('hidden');
        }

        // Refresh user list after adding new account
        function refreshUserListAfterAdd() {
            // Show success message
            document.getElementById('addAccountSuccessMessage').classList.remove('hidden');
            
            // Reload user accounts from the new database spreadsheet
            loadUserList().then(() => {
                showNotification('ğŸ”„ Daftar user berhasil diperbarui dari database baru', 'success');
            }).catch(() => {
                // Fallback to old method
                loadUserAccounts().then(() => {
                    showNotification('ğŸ”„ Daftar user berhasil diperbarui dari database', 'success');
                });
            });
            
            // Auto-hide success message after 5 seconds
            setTimeout(() => {
                document.getElementById('addAccountSuccessMessage').classList.add('hidden');
            }, 5000);
        }

        // Add event listener for reset password form
        document.addEventListener('DOMContentLoaded', function() {
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            if (resetPasswordForm) {
                resetPasswordForm.addEventListener('submit', handleResetPassword);
            }
        });

        function openSystemSettings() {
            if (!checkPermission('admin', 'mengakses pengaturan sistem')) return;
            
            document.getElementById('systemSettingsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('âš™ï¸ Membuka pengaturan sistem', 'info');
        }

        // Add login form event listener
        document.addEventListener('DOMContentLoaded', async function() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // Add username field listener for dynamic subtitle update
            const usernameField = document.getElementById('username');
            if (usernameField) {
                usernameField.addEventListener('input', function() {
                    const username = this.value.trim();
                    if (username && userAccounts[username]) {
                        updateLoginSubtitle(userAccounts[username].role);
                    } else {
                        updateLoginSubtitle('default');
                    }
                });
                
                // Also listen for blur event to handle when user clicks away
                usernameField.addEventListener('blur', function() {
                    const username = this.value.trim();
                    if (username && userAccounts[username]) {
                        updateLoginSubtitle(userAccounts[username].role);
                    } else {
                        updateLoginSubtitle('default');
                    }
                });
            }
            
            // Load user accounts first
            await loadUserAccounts();
            
            // Check for existing session
            if (!checkExistingSession()) {
                // Show login page if no session
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('mainApplication').classList.add('hidden');
            }
        });

        let allEmployees = [];
        let filteredEmployees = [];
        let currentPage = 1;
        let entriesPerPage = 10;

        // Load data from Google Sheets CSV (Integrated with Tally Form Data)
        async function loadEmployeeData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const refreshIcon = document.getElementById('refreshIcon');
            
            try {
                loadingIndicator.classList.remove('hidden');
                refreshIcon.textContent = 'â³';
                
                console.log('Loading employee data from Tally form submissions...');
                
                // Load data from the integrated spreadsheet (Tally form submissions)
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTmEWy3qKS5e_BreuEnZdXEeHvzteqlCDoLoo48OQqFaIs4uNB_Lwj3wQSdTyxn5UBGK4NtabVg7pvk/pub?gid=0&single=true&output=csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV data received from Tally integration, length:', csvText.length);
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('Empty CSV data received from Tally form');
                }
                
                // Parse CSV with better error handling
                const lines = csvText.split('\n').filter(line => line.trim());
                console.log('Total lines from Tally form:', lines.length);
                
                if (lines.length < 2) {
                    console.log('No form submissions found, using sample data...');
                    // Use sample data if no form submissions yet
                    allEmployees = getSampleEmployeeData();
                    showNotification(`ğŸ“‹ Belum ada data dari form Tally. Menggunakan data sample (${allEmployees.length} karyawan)`, 'info');
                } else {
                    const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
                    console.log('Headers found from Tally form:', headers);
                    
                    allEmployees = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = parseCSVLine(lines[i]);
                            const employee = {};
                            
                            // Map Tally form fields to our data structure
                            headers.forEach((header, index) => {
                                const value = (values[index] || '').trim().replace(/"/g, '');
                                
                                // Map common field variations from Tally form
                                if (header.toLowerCase().includes('nopek') || header.toLowerCase().includes('employee id') || header.toLowerCase().includes('id karyawan')) {
                                    employee['Nopek'] = value;
                                } else if (header.toLowerCase().includes('nama lengkap') || header.toLowerCase().includes('full name') || header.toLowerCase().includes('nama')) {
                                    employee['Nama Lengkap'] = value;
                                } else if (header.toLowerCase().includes('jabatan') || header.toLowerCase().includes('position') || header.toLowerCase().includes('job title')) {
                                    employee['Jabatan'] = value;
                                } else if (header.toLowerCase().includes('tempat kerja') || header.toLowerCase().includes('work location') || header.toLowerCase().includes('lokasi kerja')) {
                                    employee['Tempat Kerja'] = value;
                                } else if (header.toLowerCase().includes('departemen') || header.toLowerCase().includes('department') || header.toLowerCase().includes('divisi')) {
                                    employee['Departemen'] = value;
                                } else if (header.toLowerCase().includes('tempat lahir') || header.toLowerCase().includes('place of birth') || header.toLowerCase().includes('birth place')) {
                                    employee['Tempat Lahir'] = value;
                                } else if (header.toLowerCase().includes('tanggal lahir') || header.toLowerCase().includes('date of birth') || header.toLowerCase().includes('birth date')) {
                                    employee['Tanggal Lahir'] = value;
                                } else if (header.toLowerCase().includes('umur') || header.toLowerCase().includes('age') || header.toLowerCase().includes('usia')) {
                                    employee['Umur'] = value;
                                } else if (header.toLowerCase().includes('jenis kelamin') || header.toLowerCase().includes('gender') || header.toLowerCase().includes('kelamin')) {
                                    employee['Jenis Kelamin'] = value;
                                } else if (header.toLowerCase().includes('alamat') || header.toLowerCase().includes('address') || header.toLowerCase().includes('alamat lengkap')) {
                                    employee['Alamat'] = value;
                                } else if (header.toLowerCase().includes('no. hp') || header.toLowerCase().includes('phone') || header.toLowerCase().includes('telepon') || header.toLowerCase().includes('handphone')) {
                                    employee['No. HP'] = value;
                                } else if (header.toLowerCase().includes('email') || header.toLowerCase().includes('e-mail')) {
                                    employee['Email'] = value;
                                } else if (header.toLowerCase().includes('status') || header.toLowerCase().includes('employment status')) {
                                    employee['Status'] = value || 'Aktif'; // Default to Aktif if not specified
                                } else {
                                    // Store other fields as-is
                                    employee[header] = value;
                                }
                            });
                            
                            // Only add if we have essential data
                            if (employee['Nama Lengkap'] && employee['Nopek']) {
                                // Set default values for missing fields
                                if (!employee['Status']) employee['Status'] = 'Aktif';
                                if (!employee['Departemen']) employee['Departemen'] = 'Belum Ditentukan';
                                if (!employee['Jabatan']) employee['Jabatan'] = 'Belum Ditentukan';
                                
                                allEmployees.push(employee);
                            }
                        }
                    }
                    
                    console.log('Employees loaded from Tally form:', allEmployees.length);
                    
                    if (allEmployees.length === 0) {
                        console.log('No valid employee data found in form submissions, using sample data...');
                        allEmployees = getSampleEmployeeData();
                        showNotification(`ğŸ“‹ Data form Tally tidak valid. Menggunakan data sample (${allEmployees.length} karyawan)`, 'info');
                    } else {
                        showNotification(`âœ… Berhasil memuat ${allEmployees.length} data karyawan dari form Tally`, 'success');
                        
                        // Show additional info about data source
                        setTimeout(() => {
                            showNotification(`ğŸ“ Data terintegrasi dari form: https://tally.so/r/wdL77d`, 'info');
                        }, 2000);
                    }
                }
                
                // Load photo profile data from form submissions
                await loadPhotoProfileData();
                
                populateFilters();
                applyFilters();
                
            } catch (error) {
                console.error('Error loading data from Tally integration:', error);
                
                // Fallback to sample data on error
                console.log('Falling back to sample data due to error...');
                allEmployees = getSampleEmployeeData();
                
                document.getElementById('employeeTableBody').innerHTML = 
                    `<tr><td colspan="13" class="px-4 py-8 text-center text-amber-600">
                        <div class="space-y-2">
                            <div>âš ï¸ Gagal memuat data dari form Tally</div>
                            <div class="text-sm">Menggunakan data sample. Error: ${error.message}</div>
                            <div class="text-xs text-gray-500 mt-2">Form URL: https://tally.so/r/wdL77d</div>
                            <button onclick="loadEmployeeData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm mt-2">
                                ğŸ”„ Coba Lagi
                            </button>
                        </div>
                    </td></tr>`;
                
                showNotification('âš ï¸ Menggunakan data sample karena gagal memuat dari form Tally', 'error');
                
                // Still populate filters and apply them with sample data
                populateFilters();
                applyFilters();
                
            } finally {
                loadingIndicator.classList.add('hidden');
                refreshIcon.textContent = 'ğŸ”„';
            }
        }

        // Get sample employee data (fallback)
        function getSampleEmployeeData() {
            return [
                {
                    'Nopek': '12345',
                    'Nama Lengkap': 'Ahmad Suryanto',
                    'Jabatan': 'Senior Drilling Engineer',
                    'Tempat Kerja': 'Jakarta',
                    'Departemen': 'Logistic',
                    'Tempat Lahir': 'Jakarta',
                    'Tanggal Lahir': '1985-05-15',
                    'Umur': '39',
                    'Jenis Kelamin': 'Laki-laki',
                    'Alamat': 'Jl. Sudirman No. 123, Jakarta',
                    'No. HP': '081234567890',
                    'Email': 'ahmad.suryanto@pertamina.com',
                    'Status': 'Aktif'
                },
                {
                    'Nopek': '12346',
                    'Nama Lengkap': 'Siti Nurhaliza',
                    'Jabatan': 'Procurement Specialist',
                    'Tempat Kerja': 'Balikpapan',
                    'Departemen': 'Procurement',
                    'Tempat Lahir': 'Surabaya',
                    'Tanggal Lahir': '1990-08-22',
                    'Umur': '34',
                    'Jenis Kelamin': 'Perempuan',
                    'Alamat': 'Jl. Ahmad Yani No. 456, Balikpapan',
                    'No. HP': '081234567891',
                    'Email': 'siti.nurhaliza@pertamina.com',
                    'Status': 'Aktif'
                },
                {
                    'Nopek': '12347',
                    'Nama Lengkap': 'Budi Santoso',
                    'Jabatan': 'Logistics Coordinator',
                    'Tempat Kerja': 'Palembang',
                    'Departemen': 'Logistic',
                    'Tempat Lahir': 'Palembang',
                    'Tanggal Lahir': '1988-12-10',
                    'Umur': '36',
                    'Jenis Kelamin': 'Laki-laki',
                    'Alamat': 'Jl. Veteran No. 789, Palembang',
                    'No. HP': '081234567892',
                    'Email': 'budi.santoso@pertamina.com',
                    'Status': 'Aktif'
                },
                {
                    'Nopek': '12348',
                    'Nama Lengkap': 'Maya Sari',
                    'Jabatan': 'Supply Chain Analyst',
                    'Tempat Kerja': 'Jakarta',
                    'Departemen': 'Procurement',
                    'Tempat Lahir': 'Bandung',
                    'Tanggal Lahir': '1992-03-18',
                    'Umur': '32',
                    'Jenis Kelamin': 'Perempuan',
                    'Alamat': 'Jl. Gatot Subroto No. 321, Jakarta',
                    'No. HP': '081234567893',
                    'Email': 'maya.sari@pertamina.com',
                    'Status': 'Aktif'
                },
                {
                    'Nopek': '12349',
                    'Nama Lengkap': 'Rizki Pratama',
                    'Jabatan': 'Warehouse Supervisor',
                    'Tempat Kerja': 'Cilacap',
                    'Departemen': 'Logistic',
                    'Tempat Lahir': 'Yogyakarta',
                    'Tanggal Lahir': '1987-07-25',
                    'Umur': '37',
                    'Jenis Kelamin': 'Laki-laki',
                    'Alamat': 'Jl. Diponegoro No. 654, Cilacap',
                    'No. HP': '081234567894',
                    'Email': 'rizki.pratama@pertamina.com',
                    'Status': 'Aktif'
                }
            ];
        }

        // Load photo profile data from Tally form submissions
        async function loadPhotoProfileData() {
            try {
                // This would typically fetch from your photo profile form's CSV export
                // For now, we'll use the existing uploadedPhotos from localStorage
                // and simulate integration with form data
                
                // In a real implementation, you would fetch from:
                // const response = await fetch('https://docs.google.com/spreadsheets/d/YOUR_PHOTO_FORM_SHEET_ID/pub?gid=0&single=true&output=csv');
                
                // For demo purposes, we'll check if there are any new photos to integrate
                const storedPhotos = JSON.parse(localStorage.getItem('employeePhotos') || '{}');
                const formPhotos = JSON.parse(localStorage.getItem('formUploadedPhotos') || '{}');
                
                // Merge form photos with existing photos
                Object.keys(formPhotos).forEach(nopek => {
                    if (formPhotos[nopek]) {
                        uploadedPhotos[nopek] = formPhotos[nopek];
                    }
                });
                
                // Save merged photos back to localStorage
                localStorage.setItem('employeePhotos', JSON.stringify(uploadedPhotos));
                
            } catch (error) {
                console.error('Error loading photo profile data:', error);
            }
        }

        // Parse CSV line handling commas within quotes - improved version
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            let i = 0;
            
            while (i < line.length) {
                const char = line[i];
                
                if (char === '"') {
                    // Handle escaped quotes
                    if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                        current += '"';
                        i += 2;
                        continue;
                    }
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
                i++;
            }
            
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        }

        // Populate filter dropdowns
        function populateFilters() {
            const departments = [...new Set(allEmployees.map(emp => emp.Departemen).filter(d => d))].sort();
            const positions = [...new Set(allEmployees.map(emp => emp.Jabatan).filter(j => j))].sort();
            
            const departmentFilter = document.getElementById('departmentFilter');
            const positionFilter = document.getElementById('positionFilter');
            
            // Clear existing options except first
            departmentFilter.innerHTML = '<option value="">Semua Departemen</option>';
            positionFilter.innerHTML = '<option value="">Semua Jabatan</option>';
            
            departments.forEach(dept => {
                departmentFilter.innerHTML += `<option value="${dept}">${dept}</option>`;
            });
            
            positions.forEach(pos => {
                positionFilter.innerHTML += `<option value="${pos}">${pos}</option>`;
            });
        }

        // Apply filters and search
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const departmentFilter = document.getElementById('departmentFilter').value;
            const positionFilter = document.getElementById('positionFilter').value;
            
            let dataToFilter = allEmployees;
            
            // Filter data based on user role
            if (userRole === 'staff' && currentUser && userAccounts[currentUser].nopek) {
                // Staff can only see their own data
                const staffNopek = userAccounts[currentUser].nopek;
                dataToFilter = allEmployees.filter(employee => employee.Nopek === staffNopek);
            }
            
            filteredEmployees = dataToFilter.filter(employee => {
                const matchesSearch = !searchTerm || 
                    Object.values(employee).some(value => 
                        value.toString().toLowerCase().includes(searchTerm)
                    );
                
                const matchesDepartment = !departmentFilter || employee.Departemen === departmentFilter;
                const matchesPosition = !positionFilter || employee.Jabatan === positionFilter;
                
                return matchesSearch && matchesDepartment && matchesPosition;
            });
            
            currentPage = 1;
            displayEmployees();
            updatePagination();
            updateDataInfo();
        }

        // Display employees in table
        function displayEmployees() {
            const tbody = document.getElementById('employeeTableBody');
            const entriesSelect = document.getElementById('entriesSelect');
            entriesPerPage = entriesSelect.value === 'all' ? filteredEmployees.length : parseInt(entriesSelect.value);
            
            const startIndex = (currentPage - 1) * entriesPerPage;
            const endIndex = entriesSelect.value === 'all' ? filteredEmployees.length : startIndex + entriesPerPage;
            const currentEmployees = filteredEmployees.slice(startIndex, endIndex);
            
            if (currentEmployees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="px-4 py-8 text-center text-gray-500">ğŸ“­ Tidak ada data yang ditemukan</td></tr>';
                return;
            }
            
            tbody.innerHTML = currentEmployees.map((employee, index) => `
                <tr class="hover:bg-gray-50 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-25'}">
                    <td class="px-4 py-3 text-sm">${employee.Nopek || '-'}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${employee['Nama Lengkap'] || '-'}</td>
                    <td class="px-4 py-3 text-sm">${employee.Jabatan || '-'}</td>
                    <td class="px-4 py-3 text-sm">${employee['Tempat Kerja'] || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${employee.Departemen || '-'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${employee['Tempat Lahir'] || '-'}</td>
                    <td class="px-4 py-3 text-sm">${employee['Tanggal Lahir'] || '-'}</td>
                    <td class="px-4 py-3 text-sm">${employee.Umur || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            employee['Jenis Kelamin'] === 'Laki-laki' ? 'bg-blue-100 text-blue-800' : 'bg-pink-100 text-pink-800'
                        }">
                            ${employee['Jenis Kelamin'] || '-'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm max-w-xs truncate" title="${employee.Alamat || '-'}">${employee.Alamat || '-'}</td>
                    <td class="px-4 py-3 text-sm">${employee['No. HP'] || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        ${employee.Email ? `<a href="mailto:${employee.Email}" class="text-blue-600 hover:text-blue-800">${employee.Email}</a>` : '-'}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            employee.Status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${employee.Status || '-'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // Update pagination
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const entriesSelect = document.getElementById('entriesSelect');
            
            if (entriesSelect.value === 'all') {
                pagination.innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(filteredEmployees.length / entriesPerPage);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<button onclick="changePage(${currentPage - 1})" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">â€¹ Prev</button>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button onclick="changePage(1)" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="px-3 py-2">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button onclick="changePage(${i})" class="px-3 py-2 ${
                    i === currentPage ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg' : 'bg-gray-200 hover:bg-gradient-to-r hover:from-blue-100 hover:to-indigo-100 hover:text-blue-800'
                } rounded-lg transition-all duration-300">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="px-3 py-2">...</span>`;
                }
                paginationHTML += `<button onclick="changePage(${totalPages})" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">${totalPages}</button>`;
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="changePage(${currentPage + 1})" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">Next â€º</button>`;
            }
            
            pagination.innerHTML = paginationHTML;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            displayEmployees();
            updatePagination();
            updateDataInfo();
        }

        // Update data info
        function updateDataInfo() {
            const entriesSelect = document.getElementById('entriesSelect');
            const startIndex = (currentPage - 1) * entriesPerPage + 1;
            const endIndex = entriesSelect.value === 'all' ? 
                filteredEmployees.length : 
                Math.min(currentPage * entriesPerPage, filteredEmployees.length);
            
            document.getElementById('showingStart').textContent = filteredEmployees.length > 0 ? startIndex : 0;
            document.getElementById('showingEnd').textContent = endIndex;
            document.getElementById('totalEntries').textContent = filteredEmployees.length;
        }

        // Reset filters (but maintain current department view)
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('positionFilter').value = '';
            document.getElementById('entriesSelect').value = '10';
            // Keep the current department filter based on current view
            document.getElementById('departmentFilter').value = currentDepartmentView;
            applyFilters();
            
            if (currentDepartmentView) {
                showNotification(`ğŸ”„ Filter direset untuk ${currentDepartmentView === 'Logistic' ? 'Departemen Logistic' : 'Departemen Procurement'}`, 'info');
            } else {
                showNotification('ğŸ”„ Filter direset untuk semua karyawan', 'info');
            }
        }

        // Switch to department view (new tab-like behavior)
        function switchToDepartment(department) {
            // Save current department view
            currentDepartmentView = department;
            localStorage.setItem('currentDepartmentView', department);
            
            // Update navigation title
            updateNavigationTitle(department);
            
            // Reset all filters and search
            document.getElementById('searchInput').value = '';
            document.getElementById('positionFilter').value = '';
            document.getElementById('departmentFilter').value = department;
            document.getElementById('entriesSelect').value = '10';
            currentPage = 1;
            
            // Apply filters
            applyFilters();
            
            // Show notification of what's being viewed
            if (department === 'Logistic') {
                showNotification('ğŸ“¦ Beralih ke Tab Departemen Logistic', 'success');
            } else if (department === 'Procurement') {
                showNotification('ğŸ›’ Beralih ke Tab Departemen Procurement', 'success');
            } else {
                showNotification('ğŸ‘¥ Beralih ke Tab Semua Karyawan', 'info');
            }
        }
        
        // Update navigation title based on current department view
        function updateNavigationTitle(department) {
            const titleElement = document.getElementById('currentDepartmentTitle');
            const tabIndicator = document.getElementById('departmentTabIndicator');
            const tabIcon = document.getElementById('tabIcon');
            const tabTitle = document.getElementById('tabTitle');
            
            if (department === 'Logistic') {
                titleElement.textContent = 'ğŸ“¦ Logistic';
                tabIcon.textContent = 'ğŸ“¦';
                tabTitle.textContent = 'Departemen Logistic';
                tabIndicator.classList.remove('hidden');
                // Change gradient color for Logistic
                tabIndicator.querySelector('div').className = 'bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg p-4';
            } else if (department === 'Procurement') {
                titleElement.textContent = 'ğŸ›’ Procurement';
                tabIcon.textContent = 'ğŸ›’';
                tabTitle.textContent = 'Departemen Procurement';
                tabIndicator.classList.remove('hidden');
                // Change gradient color for Procurement
                tabIndicator.querySelector('div').className = 'bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl shadow-lg p-4';
            } else {
                titleElement.textContent = 'Data Karyawan';
                tabIndicator.classList.add('hidden');
            }
        }
        
        // Filter by department from dropdown menu (legacy function for compatibility)
        function filterByDepartment(department) {
            switchToDepartment(department);
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            // Remove existing notification if any
            const existingNotification = document.getElementById('notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = `fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
            
            // Set colors based on type
            if (type === 'success') {
                notification.className += ' bg-green-500 text-white';
            } else if (type === 'info') {
                notification.className += ' bg-blue-500 text-white';
            } else {
                notification.className += ' bg-gray-500 text-white';
            }
            
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        âœ•
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('departmentFilter').addEventListener('change', applyFilters);
        document.getElementById('positionFilter').addEventListener('change', applyFilters);
        document.getElementById('entriesSelect').addEventListener('change', () => {
            currentPage = 1;
            displayEmployees();
            updatePagination();
            updateDataInfo();
        });
        document.getElementById('refreshBtn').addEventListener('click', loadEmployeeData);
        document.getElementById('resetBtn').addEventListener('click', resetFilters);

        // Storage for uploaded photos
        let uploadedPhotos = JSON.parse(localStorage.getItem('employeePhotos') || '{}');
        
        // Current department state
        let currentDepartmentView = localStorage.getItem('currentDepartmentView') || '';

        // Photo upload modal functions
        function openPhotoUpload(nopek, name) {
            document.getElementById('modalEmployeeNopek').textContent = nopek;
            document.getElementById('modalEmployeeName').textContent = name;
            document.getElementById('employeeNopek').value = nopek;
            document.getElementById('employeeName').value = name;
            
            // Set current date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('uploadDate').value = today;
            
            // Reset form
            document.getElementById('photoUploadForm').reset();
            document.getElementById('employeeNopek').value = nopek;
            document.getElementById('employeeName').value = name;
            document.getElementById('uploadDate').value = today;
            
            // Show existing photo if available
            const preview = document.getElementById('photoPreview');
            if (uploadedPhotos[nopek]) {
                preview.innerHTML = `<img src="${uploadedPhotos[nopek].photoData}" alt="Foto ${name}" class="w-full h-full object-cover rounded-full">`;
            } else {
                preview.innerHTML = '<span class="text-4xl text-gray-400">ğŸ“·</span>';
            }
            
            // Hide message
            document.getElementById('uploadMessage').classList.add('hidden');
            
            document.getElementById('photoUploadModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closePhotoUpload() {
            document.getElementById('photoUploadModal').classList.add('hidden');
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        function refreshAfterUpload() {
            closePhotoUpload();
            loadEmployeeData();
            showNotification('ğŸ”„ Data sedang diperbarui...', 'info');
        }

        // Photo preview function
        function previewPhoto(file) {
            const preview = document.getElementById('photoPreview');
            
            if (file) {
                // Check file size (2MB limit)
                if (file.size > 2 * 1024 * 1024) {
                    showUploadMessage('âŒ Ukuran file terlalu besar. Maksimal 2MB.', 'error');
                    return false;
                }
                
                // Check file type
                if (!file.type.match('image.*')) {
                    showUploadMessage('âŒ File harus berupa gambar (JPG/PNG).', 'error');
                    return false;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-cover rounded-full">`;
                };
                reader.readAsDataURL(file);
                return true;
            }
        }

        // Show upload message
        function showUploadMessage(message, type) {
            const messageDiv = document.getElementById('uploadMessage');
            messageDiv.classList.remove('hidden');
            
            if (type === 'success') {
                messageDiv.className = 'bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg';
            } else if (type === 'error') {
                messageDiv.className = 'bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg';
            } else {
                messageDiv.className = 'bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg';
            }
            
            messageDiv.innerHTML = `<div class="flex items-center gap-2"><span>${message}</span></div>`;
            
            // Auto hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Handle photo upload form submission
        function handlePhotoUpload(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const photoFile = document.getElementById('photoFile').files[0];
            const uploadBtn = document.getElementById('uploadBtn');
            
            // Validate required fields
            if (!photoFile) {
                showUploadMessage('âŒ Silakan pilih foto terlebih dahulu.', 'error');
                return;
            }
            
            if (!formData.get('uploadDate')) {
                showUploadMessage('âŒ Tanggal upload harus diisi.', 'error');
                return;
            }
            
            // Validate photo
            if (!previewPhoto(photoFile)) {
                return;
            }
            
            // Show loading state
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<div class="loading"></div> Mengupload...';
            
            // Simulate upload process (since this is a demo)
            setTimeout(() => {
                // In a real application, you would send the data to your server here
                // For demo purposes, we'll save to localStorage and show success message
                
                const employeeName = formData.get('name');
                const nopek = formData.get('nopek');
                const uploadDate = formData.get('uploadDate');
                const notes = formData.get('notes');
                
                // Convert photo to base64 and save to localStorage
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Save photo data
                    uploadedPhotos[nopek] = {
                        photoData: e.target.result,
                        employeeName: employeeName,
                        uploadDate: uploadDate,
                        notes: notes,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('employeePhotos', JSON.stringify(uploadedPhotos));
                    
                    showUploadMessage(`âœ… Foto untuk ${employeeName} (${nopek}) berhasil diupload!`, 'success');
                    
                    // Reset button
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<span>ğŸ“·</span> Upload Foto';
                    
                    // Show notification
                    showNotification(`ğŸ“· Foto ${employeeName} berhasil diupload`, 'success');
                    
                    // Refresh table display to show new photo
                    displayEmployees();
                    
                    // Auto close modal after 2 seconds
                    setTimeout(() => {
                        closePhotoUpload();
                    }, 2000);
                };
                reader.readAsDataURL(photoFile);
                
            }, 2000); // Simulate 2 second upload time
        }

        // Close modal when clicking outside
        document.getElementById('photoUploadModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePhotoUpload();
            }
        });

        // Photo view functions
        let currentViewingNopek = null;

        function viewPhoto(nopek, name) {
            const photoData = uploadedPhotos[nopek];
            if (!photoData) return;
            
            currentViewingNopek = nopek;
            
            // Set photo and details
            document.getElementById('viewPhotoContainer').innerHTML = 
                `<img src="${photoData.photoData}" alt="Foto ${name}" class="w-full h-full object-cover">`;
            document.getElementById('viewEmployeeName').textContent = name;
            document.getElementById('viewEmployeeNopek').textContent = nopek;
            document.getElementById('viewUploadDate').textContent = photoData.uploadDate || '-';
            
            // Show notes if available
            const notesDiv = document.getElementById('viewPhotoNotes');
            const notesContent = document.getElementById('viewNotesContent');
            if (photoData.notes && photoData.notes.trim()) {
                notesContent.textContent = photoData.notes;
                notesDiv.classList.remove('hidden');
            } else {
                notesDiv.classList.add('hidden');
            }
            
            document.getElementById('photoViewModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closePhotoView() {
            document.getElementById('photoViewModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentViewingNopek = null;
        }

        function editPhotoFromView() {
            if (currentViewingNopek) {
                const employee = allEmployees.find(emp => emp.Nopek === currentViewingNopek);
                if (employee) {
                    closePhotoView();
                    openPhotoUpload(currentViewingNopek, employee['Nama Lengkap']);
                }
            }
        }

        // Close modal when clicking outside
        document.getElementById('photoViewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePhotoView();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePhotoUpload();
                closePhotoView();
            }
        });

        // Photo upload form event listeners
        document.getElementById('photoUploadForm').addEventListener('submit', handlePhotoUpload);
        
        // Photo file input change event
        document.getElementById('photoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                previewPhoto(file);
            }
        });

        // Update clock and date
        function updateDateTime() {
            const now = new Date();
            
            // Format time (HH:MM:SS)
            const timeString = now.toLocaleTimeString('id-ID', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Format date (Day, DD Month YYYY)
            const dateString = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('currentDate').textContent = dateString;
        }

        // Input Data Karyawan Modal Functions
        function openInputDataKaryawan() {
            document.getElementById('inputDataKaryawanModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ‘¥ Membuka form input data karyawan', 'info');
            
            // Hide success message when opening
            document.getElementById('dataKaryawanSuccessMessage').classList.add('hidden');
        }

        function closeInputDataKaryawan() {
            document.getElementById('inputDataKaryawanModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function refreshDataKaryawanForm() {
            const iframe = document.getElementById('inputDataKaryawanFrame');
            iframe.src = 'https://tally.so/r/wdL77d'; // Reload iframe with Tally form URL
            showNotification('ğŸ”„ Form input data karyawan berhasil di-refresh', 'success');
            
            // Hide success message when refreshing
            document.getElementById('dataKaryawanSuccessMessage').classList.add('hidden');
        }

        function refreshDataAfterInput() {
            // Show success message
            document.getElementById('dataKaryawanSuccessMessage').classList.remove('hidden');
            
            // Show loading notification
            showNotification('ğŸ”„ Memuat data terbaru dari form Tally...', 'info');
            
            // Refresh employee data from the Tally-integrated spreadsheet
            loadEmployeeData().then(() => {
                // Also refresh dashboard data if it's loaded
                if (allPersonnelData && allPersonnelData.length > 0) {
                    loadDashboardData();
                }
                
                showNotification('âœ… Data karyawan berhasil diperbarui dari form Tally', 'success');
                
                // Show additional confirmation
                setTimeout(() => {
                    showNotification('ğŸ“Š Data terbaru telah dimuat ke tabel dan dashboard', 'info');
                }, 2000);
                
            }).catch((error) => {
                console.error('Error refreshing data after input:', error);
                showNotification('âš ï¸ Gagal memuat data terbaru, silakan coba refresh manual', 'error');
            });
            
            // Auto-hide success message after 7 seconds
            setTimeout(() => {
                document.getElementById('dataKaryawanSuccessMessage').classList.add('hidden');
            }, 7000);
        }

        // Simulate photo integration from form submissions
        function simulatePhotoIntegration() {
            // This function simulates receiving photo data from the Tally form
            // In a real implementation, this would fetch actual form submission data
            
            // Check if there are employees that could receive sample photos
            if (allEmployees.length > 0) {
                // Create sample photos for first few employees
                const formPhotos = JSON.parse(localStorage.getItem('formUploadedPhotos') || '{}');
                
                // Add sample photos for first 3 employees if they don't have photos yet
                allEmployees.slice(0, 3).forEach((employee, index) => {
                    if (employee && employee.Nopek && !formPhotos[employee.Nopek]) {
                        const nopek = employee.Nopek;
                        const name = employee['Nama Lengkap'] || 'Unknown';
                        const colors = ['#10B981', '#3B82F6', '#8B5CF6'];
                        const color = colors[index % colors.length];
                        
                        // Create a sample photo for this employee
                        formPhotos[nopek] = {
                            photoData: `data:image/svg+xml;base64,${btoa(`<svg width="120" height="120" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="grad${index}" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:${color};stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:${color}AA;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect width="120" height="120" fill="url(#grad${index})" rx="10"/>
                                <circle cx="60" cy="45" r="20" fill="white" opacity="0.9"/>
                                <path d="M35 85 Q35 75 45 75 L75 75 Q85 75 85 85 L85 95 Q85 105 75 105 L45 105 Q35 105 35 95 Z" fill="white" opacity="0.9"/>
                                <text x="60" y="52" font-family="Arial" font-size="16" fill="${color}" text-anchor="middle" font-weight="bold">ğŸ‘¤</text>
                                <text x="60" y="115" font-family="Arial" font-size="8" fill="white" text-anchor="middle">${name.split(' ')[0]}</text>
                            </svg>`)}`,
                            employeeName: name,
                            uploadDate: new Date().toISOString().split('T')[0],
                            notes: 'Foto profil simulasi dari form online',
                            timestamp: new Date().toISOString(),
                            source: 'form_temp'
                        };
                    }
                });
                
                localStorage.setItem('formUploadedPhotos', JSON.stringify(formPhotos));
                console.log('Sample photos created for testing:', Object.keys(formPhotos));
            }
        }

        // Add test photos for demonstration
        function addTestPhotos() {
            if (allPersonnelData.length > 0) {
                const testPhotos = {};
                
                // Add test photos for first few employees
                allPersonnelData.slice(0, 2).forEach((employee, index) => {
                    if (employee.Nopek) {
                        const colors = ['#059669', '#DC2626'];
                        const names = ['Ahmad', 'Siti'];
                        
                        testPhotos[employee.Nopek] = {
                            photoUrl: `data:image/svg+xml;base64,${btoa(`<svg width="150" height="150" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <radialGradient id="bg${index}" cx="50%" cy="30%" r="70%">
                                        <stop offset="0%" style="stop-color:${colors[index]};stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:${colors[index]}CC;stop-opacity:1" />
                                    </radialGradient>
                                </defs>
                                <rect width="150" height="150" fill="url(#bg${index})"/>
                                <circle cx="75" cy="60" r="25" fill="white" opacity="0.95"/>
                                <ellipse cx="75" cy="120" rx="35" ry="45" fill="white" opacity="0.95"/>
                                <text x="75" y="70" font-family="Arial" font-size="20" fill="${colors[index]}" text-anchor="middle">ğŸ˜Š</text>
                                <text x="75" y="145" font-family="Arial" font-size="10" fill="white" text-anchor="middle" font-weight="bold">${names[index] || employee['Nama Lengkap']?.split(' ')[0] || 'User'}</text>
                            </svg>`)}`,
                            uploadDate: new Date().toISOString().split('T')[0],
                            notes: 'Foto test untuk demonstrasi',
                            source: 'test'
                        };
                    }
                });
                
                // Merge with existing photos
                Object.assign(personnelPhotos, testPhotos);
                console.log('Test photos added:', Object.keys(testPhotos));
                
                // Update display
                displayPersonnelCards();
                updateDashboardStats();
            }
        }

        // Report Modal Functions
        function openInputLaporan() {
            document.getElementById('inputLaporanModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ“ Membuka form input laporan', 'info');
        }

        function closeInputLaporan() {
            document.getElementById('inputLaporanModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function refreshInputForm() {
            const iframe = document.getElementById('inputLaporanFrame');
            iframe.src = iframe.src; // Reload iframe
            showNotification('ğŸ”„ Form berhasil di-refresh', 'success');
        }



        function openDisplayLaporan() {
            document.getElementById('displayLaporanModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ“Š Membuka display laporan', 'info');
            
            // Initialize report filters if not already done
            if (!document.getElementById('reportSearchInput').hasEventListener) {
                initializeReportFilters();
                document.getElementById('reportSearchInput').hasEventListener = true;
            }
            
            // Load report data if not already loaded
            if (allReports.length === 0) {
                loadReportData();
            }
        }

        function closeDisplayLaporan() {
            document.getElementById('displayLaporanModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function refreshDisplayLaporan() {
            loadReportData();
        }

        // Report data management
        let allReports = [];
        let filteredReports = [];
        let currentReportPage = 1;
        const reportsPerPage = 10;

        // Load report data from Google Sheets CSV
        async function loadReportData() {
            const loadingIndicator = document.getElementById('reportLoadingIndicator');
            const refreshIcon = document.getElementById('reportRefreshIcon');
            
            try {
                loadingIndicator.classList.remove('hidden');
                refreshIcon.textContent = 'â³';
                
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTp7rhwHJqFUcoraAhXxstcNB6SnMp-YL_PsuibKCRGBF7-0vJIA-R2E9WAauJZ3cxZtpEfhMQxe7hi/pub?gid=0&single=true&output=csv');
                const csvText = await response.text();
                
                // Parse CSV
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                allReports = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = parseCSVLine(lines[i]);
                        const report = {};
                        headers.forEach((header, index) => {
                            report[header] = values[index] || '';
                        });
                        allReports.push(report);
                    }
                }
                
                applyReportFilters();
                showNotification('âœ… Data laporan berhasil dimuat', 'success');
                
            } catch (error) {
                console.error('Error loading report data:', error);
                document.getElementById('reportTableBody').innerHTML = 
                    '<tr><td colspan="6" class="px-4 py-8 text-center text-red-600">âŒ Gagal memuat data laporan. Silakan coba lagi.</td></tr>';
                showNotification('âŒ Gagal memuat data laporan', 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
                refreshIcon.textContent = 'ğŸ”„';
            }
        }

        // Apply report filters and search
        function applyReportFilters() {
            const searchTerm = document.getElementById('reportSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('reportDateFilter').value;
            
            filteredReports = allReports.filter(report => {
                const matchesSearch = !searchTerm || 
                    Object.values(report).some(value => 
                        value.toString().toLowerCase().includes(searchTerm)
                    );
                
                const matchesDate = !dateFilter || report.Tanggal === dateFilter;
                
                return matchesSearch && matchesDate;
            });
            
            currentReportPage = 1;
            displayReports();
            updateReportPagination();
            updateReportDataInfo();
        }

        // Display reports in table
        function displayReports() {
            const tbody = document.getElementById('reportTableBody');
            
            const startIndex = (currentReportPage - 1) * reportsPerPage;
            const endIndex = startIndex + reportsPerPage;
            const currentReports = filteredReports.slice(startIndex, endIndex);
            
            if (currentReports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">ğŸ“­ Tidak ada data laporan yang ditemukan</td></tr>';
                return;
            }
            
            tbody.innerHTML = currentReports.map((report, index) => `
                <tr class="hover:bg-gray-50 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-25'}">
                    <td class="px-4 py-3 text-sm">${report.Tanggal || '-'}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${report['Rig PDSI'] || '-'}</td>
                    <td class="px-4 py-3 text-sm">${report.Lokasi || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(report.Status)}">
                            ${report.Status || '-'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${report['Personel In Charge'] || '-'}</td>
                    <td class="px-4 py-3 text-sm max-w-xs truncate" title="${report['Aktivitas Pekerja'] || '-'}">${report['Aktivitas Pekerja'] || '-'}</td>
                </tr>
            `).join('');
        }

        // Get status color based on status value
        function getStatusColor(status) {
            if (!status) return 'bg-gray-100 text-gray-800';
            
            const statusLower = status.toLowerCase();
            if (statusLower.includes('aktif') || statusLower.includes('berjalan') || statusLower.includes('operasi')) {
                return 'bg-green-100 text-green-800';
            } else if (statusLower.includes('maintenance') || statusLower.includes('perbaikan')) {
                return 'bg-yellow-100 text-yellow-800';
            } else if (statusLower.includes('stop') || statusLower.includes('berhenti')) {
                return 'bg-red-100 text-red-800';
            } else if (statusLower.includes('standby') || statusLower.includes('siaga')) {
                return 'bg-blue-100 text-blue-800';
            } else {
                return 'bg-gray-100 text-gray-800';
            }
        }

        // Update report pagination
        function updateReportPagination() {
            const pagination = document.getElementById('reportPagination');
            const totalPages = Math.ceil(filteredReports.length / reportsPerPage);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            if (currentReportPage > 1) {
                paginationHTML += `<button onclick="changeReportPage(${currentReportPage - 1})" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">â€¹ Prev</button>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentReportPage - 2);
            const endPage = Math.min(totalPages, currentReportPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button onclick="changeReportPage(1)" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="px-3 py-2">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button onclick="changeReportPage(${i})" class="px-3 py-2 ${
                    i === currentReportPage ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg' : 'bg-gray-200 hover:bg-gradient-to-r hover:from-blue-100 hover:to-indigo-100 hover:text-blue-800'
                } rounded-lg transition-all duration-300">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="px-3 py-2">...</span>`;
                }
                paginationHTML += `<button onclick="changeReportPage(${totalPages})" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">${totalPages}</button>`;
            }
            
            // Next button
            if (currentReportPage < totalPages) {
                paginationHTML += `<button onclick="changeReportPage(${currentReportPage + 1})" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">Next â€º</button>`;
            }
            
            pagination.innerHTML = paginationHTML;
        }

        // Change report page
        function changeReportPage(page) {
            currentReportPage = page;
            displayReports();
            updateReportPagination();
            updateReportDataInfo();
        }

        // Update report data info
        function updateReportDataInfo() {
            const startIndex = (currentReportPage - 1) * reportsPerPage + 1;
            const endIndex = Math.min(currentReportPage * reportsPerPage, filteredReports.length);
            
            document.getElementById('reportShowingStart').textContent = filteredReports.length > 0 ? startIndex : 0;
            document.getElementById('reportShowingEnd').textContent = endIndex;
            document.getElementById('reportTotalEntries').textContent = filteredReports.length;
        }

        // Refresh report data
        function refreshReportData() {
            loadReportData();
        }

        // Reset report filters
        function resetReportFilters() {
            document.getElementById('reportSearchInput').value = '';
            document.getElementById('reportDateFilter').value = '';
            applyReportFilters();
            showNotification('ğŸ”„ Filter laporan direset', 'info');
        }

        // Add event listeners for report filters
        function initializeReportFilters() {
            document.getElementById('reportSearchInput').addEventListener('input', applyReportFilters);
            document.getElementById('reportDateFilter').addEventListener('change', applyReportFilters);
        }

        function openPrintLaporan() {
            document.getElementById('printLaporanModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ–¨ï¸ Membuka menu print laporan', 'info');
        }

        function closePrintLaporan() {
            document.getElementById('printLaporanModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function generatePrintPreview() {
            showNotification('ğŸ‘ï¸ Generating preview laporan...', 'info');
            
            // Update preview with actual data from display laporan
            const previewBody = document.getElementById('printPreviewBody');
            const previewPeriod = document.getElementById('previewPeriod');
            const previewTotalRecords = document.getElementById('previewTotalRecords');
            const previewGeneratedDate = document.getElementById('previewGeneratedDate');
            
            // Get selected report type and dates
            const reportType = document.querySelector('input[name="reportType"]:checked')?.value || 'monthly';
            const fromDate = document.querySelector('input[type="date"]').value;
            const toDate = document.querySelectorAll('input[type="date"]')[1].value;
            
            // Update period text
            let periodText = '';
            if (fromDate && toDate) {
                periodText = `${fromDate} s/d ${toDate}`;
            } else {
                const typeText = {
                    'daily': 'Harian',
                    'weekly': 'Mingguan', 
                    'monthly': 'Bulanan',
                    'yearly': 'Tahunan'
                };
                periodText = `Laporan ${typeText[reportType]} - ${new Date().getFullYear()}`;
            }
            previewPeriod.textContent = periodText;
            
            // Update generated date
            const now = new Date();
            previewGeneratedDate.textContent = now.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Use actual report data if available
            if (filteredReports && filteredReports.length > 0) {
                const sampleReports = filteredReports.slice(0, 5); // Show first 5 records as preview
                previewBody.innerHTML = sampleReports.map((report, index) => `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                        <td class="px-2 py-2 text-gray-600">${report.Tanggal || '-'}</td>
                        <td class="px-2 py-2 font-medium">${report['Rig PDSI'] || '-'}</td>
                        <td class="px-2 py-2">${report.Lokasi || '-'}</td>
                        <td class="px-2 py-2">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(report.Status)}">
                                ${report.Status || '-'}
                            </span>
                        </td>
                        <td class="px-2 py-2">${report['Personel In Charge'] || '-'}</td>
                        <td class="px-2 py-2">${report['Aktivitas Pekerja'] || '-'}</td>
                    </tr>
                `).join('');
                
                previewTotalRecords.textContent = filteredReports.length;
                
                if (filteredReports.length > 5) {
                    previewBody.innerHTML += `
                        <tr class="bg-blue-50">
                            <td colspan="6" class="px-2 py-2 text-center text-blue-600 text-xs">
                                ... dan ${filteredReports.length - 5} record lainnya akan ditampilkan dalam laporan lengkap
                            </td>
                        </tr>
                    `;
                }
            } else {
                previewTotalRecords.textContent = '0';
                previewBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-2 py-2 text-center text-gray-500 text-xs">
                            Tidak ada data untuk periode yang dipilih
                        </td>
                    </tr>
                `;
            }
            
            setTimeout(() => {
                showNotification('âœ… Preview laporan berhasil diperbarui', 'success');
            }, 1000);
        }

        function printReport() {
            showNotification('ğŸ–¨ï¸ Memproses pencetakan laporan...', 'info');
            
            // Create print window with the report data
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            
            // Get current preview data
            const previewPeriod = document.getElementById('previewPeriod').textContent;
            const previewTotalRecords = document.getElementById('previewTotalRecords').textContent;
            const previewGeneratedDate = document.getElementById('previewGeneratedDate').textContent;
            
            // Generate full report HTML
            let reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan PT Pertamina Drilling</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .header h1 { margin: 0; font-size: 24px; }
                        .header h2 { margin: 5px 0; font-size: 16px; color: #666; }
                        .header p { margin: 5px 0; font-size: 12px; color: #888; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 11px; }
                        th { background-color: #f5f5f5; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .footer { margin-top: 30px; border-top: 1px solid #ddd; padding-top: 10px; font-size: 10px; color: #666; }
                        .status { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
                        .status-operasi { background-color: #d4edda; color: #155724; }
                        .status-maintenance { background-color: #fff3cd; color: #856404; }
                        .status-standby { background-color: #d1ecf1; color: #0c5460; }
                        .status-stop { background-color: #f8d7da; color: #721c24; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>PT PERTAMINA DRILLING</h1>
                        <h2>Laporan Aktivitas Operasional</h2>
                        <p>Periode: ${previewPeriod}</p>
                        <p>Total Records: ${previewTotalRecords} | Generated: ${previewGeneratedDate}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Rig PDSI</th>
                                <th>Lokasi</th>
                                <th>Status</th>
                                <th>Personel In Charge</th>
                                <th>Aktivitas Pekerja</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add actual data or sample data
            if (filteredReports && filteredReports.length > 0) {
                filteredReports.forEach(report => {
                    const statusClass = getStatusClassForPrint(report.Status);
                    reportHTML += `
                        <tr>
                            <td>${report.Tanggal || '-'}</td>
                            <td>${report['Rig PDSI'] || '-'}</td>
                            <td>${report.Lokasi || '-'}</td>
                            <td><span class="status ${statusClass}">${report.Status || '-'}</span></td>
                            <td>${report['Personel In Charge'] || '-'}</td>
                            <td>${report['Aktivitas Pekerja'] || '-'}</td>
                        </tr>
                    `;
                });
            } else {
                reportHTML += `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666;">Tidak ada data untuk periode yang dipilih</td>
                    </tr>
                `;
            }
            
            reportHTML += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Laporan ini digenerate secara otomatis oleh Sistem Manajemen PT Pertamina Drilling</p>
                        <p>Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
                    </div>
                    
                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ–¨ï¸ Print</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">âŒ Close</button>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            
            setTimeout(() => {
                showNotification('âœ… Laporan siap untuk dicetak', 'success');
            }, 1000);
        }
        
        // Helper function to get status class for print
        function getStatusClassForPrint(status) {
            if (!status) return '';
            
            const statusLower = status.toLowerCase();
            if (statusLower.includes('operasi') || statusLower.includes('aktif')) {
                return 'status-operasi';
            } else if (statusLower.includes('maintenance') || statusLower.includes('perbaikan')) {
                return 'status-maintenance';
            } else if (statusLower.includes('standby') || statusLower.includes('siaga')) {
                return 'status-standby';
            } else if (statusLower.includes('stop') || statusLower.includes('berhenti')) {
                return 'status-stop';
            }
            return '';
        }

        // Close modals when clicking outside
        document.getElementById('inputDataKaryawanModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInputDataKaryawan();
            }
        });

        document.getElementById('inputLaporanModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInputLaporan();
            }
        });

        document.getElementById('displayLaporanModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDisplayLaporan();
            }
        });

        document.getElementById('printLaporanModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePrintLaporan();
            }
        });

        // Dashboard functionality
        let allPersonnelData = [];
        let filteredPersonnelData = [];
        let personnelPhotos = {};
        let currentDashboardPage = 1;
        const personnelPerPage = 12;

        // Show Dashboard (Main Landing Page)
        function showDashboard() {
            // Check permission for dashboard access - allow admin and administrator
            const normalizedRole = userRole ? userRole.toLowerCase() : '';
            if (normalizedRole === 'staff') {
                showNotification('âŒ Akses dashboard hanya tersedia untuk Administrator', 'error');
                return;
            }
            
            // Hide data karyawan section
            document.getElementById('dataKaryawanSection').classList.add('hidden');
            // Show main dashboard
            document.getElementById('mainDashboard').classList.remove('hidden');
            
            showNotification('ğŸ“Š Menampilkan Dashboard Utama', 'info');
            
            // Load dashboard data if not already loaded
            if (allPersonnelData.length === 0) {
                loadDashboardData();
            } else {
                updateDashboardStats();
                applyDashboardFilters();
            }
        }

        // Show Data Karyawan Table
        function showDataKaryawan(department = '') {
            // Check permission for data karyawan access - allow admin and administrator
            const normalizedRole = userRole ? userRole.toLowerCase() : '';
            if (normalizedRole === 'staff') {
                showNotification('âŒ Akses data karyawan hanya tersedia untuk Administrator', 'error');
                return;
            }
            
            // Hide main dashboard
            document.getElementById('mainDashboard').classList.add('hidden');
            // Show data karyawan section
            document.getElementById('dataKaryawanSection').classList.remove('hidden');
            
            // Switch to department view
            switchToDepartment(department);
            
            if (department === 'Logistic') {
                showNotification('ğŸ“¦ Menampilkan Data Karyawan Logistic', 'info');
            } else if (department === 'Procurement') {
                showNotification('ğŸ›’ Menampilkan Data Karyawan Procurement', 'info');
            } else {
                showNotification('ğŸ‘¥ Menampilkan Semua Data Karyawan', 'info');
            }
        }

        // Open Dashboard (Legacy function for modal - kept for compatibility)
        function openDashboard() {
            document.getElementById('dashboardModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ“Š Membuka dashboard personel', 'info');
            
            // Load dashboard data if not already loaded
            if (allPersonnelData.length === 0) {
                loadDashboardData();
            } else {
                updateDashboardStats();
                applyDashboardFilters();
            }
        }

        // Close Dashboard
        function closeDashboard() {
            document.getElementById('dashboardModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Load dashboard data from Tally form integration
        async function loadDashboardData() {
            const loadingIndicator = document.getElementById('dashboardLoadingIndicator');
            const refreshIcon = document.getElementById('dashboardRefreshIcon');
            
            try {
                loadingIndicator.classList.remove('hidden');
                refreshIcon.textContent = 'â³';
                
                console.log('Loading dashboard data from Tally form integration...');
                
                // Use existing allEmployees data if available, otherwise load fresh data from Tally
                if (allEmployees && allEmployees.length > 0) {
                    allPersonnelData = [...allEmployees];
                    console.log('Using existing employee data for dashboard:', allPersonnelData.length);
                } else {
                    // Load employee data fresh from Tally form integration
                    console.log('Loading fresh data from Tally form for dashboard...');
                    const employeeResponse = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTmEWy3qKS5e_BreuEnZdXEeHvzteqlCDoLoo48OQqFaIs4uNB_Lwj3wQSdTyxn5UBGK4NtabVg7pvk/pub?gid=0&single=true&output=csv');
                    
                    if (!employeeResponse.ok) {
                        throw new Error(`HTTP error! status: ${employeeResponse.status}`);
                    }
                    
                    const employeeCsvText = await employeeResponse.text();
                    console.log('Dashboard CSV data received from Tally integration, length:', employeeCsvText.length);
                    
                    if (!employeeCsvText || employeeCsvText.trim().length === 0) {
                        console.log('No Tally form data for dashboard, using sample data...');
                        allPersonnelData = getSampleEmployeeData();
                    } else {
                        // Parse employee data with Tally form field mapping
                        const employeeLines = employeeCsvText.split('\n').filter(line => line.trim());
                        
                        if (employeeLines.length < 2) {
                            console.log('No form submissions for dashboard, using sample data...');
                            allPersonnelData = getSampleEmployeeData();
                        } else {
                            const employeeHeaders = parseCSVLine(employeeLines[0]).map(h => h.trim().replace(/"/g, ''));
                            console.log('Dashboard headers from Tally form:', employeeHeaders);
                            
                            allPersonnelData = [];
                            for (let i = 1; i < employeeLines.length; i++) {
                                if (employeeLines[i].trim()) {
                                    const values = parseCSVLine(employeeLines[i]);
                                    const employee = {};
                                    
                                    // Map Tally form fields to our data structure (same as loadEmployeeData)
                                    employeeHeaders.forEach((header, index) => {
                                        const value = (values[index] || '').trim().replace(/"/g, '');
                                        
                                        // Map common field variations from Tally form
                                        if (header.toLowerCase().includes('nopek') || header.toLowerCase().includes('employee id') || header.toLowerCase().includes('id karyawan')) {
                                            employee['Nopek'] = value;
                                        } else if (header.toLowerCase().includes('nama lengkap') || header.toLowerCase().includes('full name') || header.toLowerCase().includes('nama')) {
                                            employee['Nama Lengkap'] = value;
                                        } else if (header.toLowerCase().includes('jabatan') || header.toLowerCase().includes('position') || header.toLowerCase().includes('job title')) {
                                            employee['Jabatan'] = value;
                                        } else if (header.toLowerCase().includes('tempat kerja') || header.toLowerCase().includes('work location') || header.toLowerCase().includes('lokasi kerja')) {
                                            employee['Tempat Kerja'] = value;
                                        } else if (header.toLowerCase().includes('departemen') || header.toLowerCase().includes('department') || header.toLowerCase().includes('divisi')) {
                                            employee['Departemen'] = value;
                                        } else if (header.toLowerCase().includes('tempat lahir') || header.toLowerCase().includes('place of birth') || header.toLowerCase().includes('birth place')) {
                                            employee['Tempat Lahir'] = value;
                                        } else if (header.toLowerCase().includes('tanggal lahir') || header.toLowerCase().includes('date of birth') || header.toLowerCase().includes('birth date')) {
                                            employee['Tanggal Lahir'] = value;
                                        } else if (header.toLowerCase().includes('umur') || header.toLowerCase().includes('age') || header.toLowerCase().includes('usia')) {
                                            employee['Umur'] = value;
                                        } else if (header.toLowerCase().includes('jenis kelamin') || header.toLowerCase().includes('gender') || header.toLowerCase().includes('kelamin')) {
                                            employee['Jenis Kelamin'] = value;
                                        } else if (header.toLowerCase().includes('alamat') || header.toLowerCase().includes('address') || header.toLowerCase().includes('alamat lengkap')) {
                                            employee['Alamat'] = value;
                                        } else if (header.toLowerCase().includes('no. hp') || header.toLowerCase().includes('phone') || header.toLowerCase().includes('telepon') || header.toLowerCase().includes('handphone')) {
                                            employee['No. HP'] = value;
                                        } else if (header.toLowerCase().includes('email') || header.toLowerCase().includes('e-mail')) {
                                            employee['Email'] = value;
                                        } else if (header.toLowerCase().includes('status') || header.toLowerCase().includes('employment status')) {
                                            employee['Status'] = value || 'Aktif';
                                        } else {
                                            employee[header] = value;
                                        }
                                    });
                                    
                                    // Only add if we have essential data
                                    if (employee['Nama Lengkap'] && employee['Nopek']) {
                                        // Set default values for missing fields
                                        if (!employee['Status']) employee['Status'] = 'Aktif';
                                        if (!employee['Departemen']) employee['Departemen'] = 'Belum Ditentukan';
                                        if (!employee['Jabatan']) employee['Jabatan'] = 'Belum Ditentukan';
                                        
                                        allPersonnelData.push(employee);
                                    }
                                }
                            }
                            
                            if (allPersonnelData.length === 0) {
                                console.log('No valid personnel data from Tally form, using sample data...');
                                allPersonnelData = getSampleEmployeeData();
                            }
                        }
                    }
                }
                
                console.log('Personnel data loaded for dashboard:', allPersonnelData.length);
                
                // Load photo data from multiple sources
                await loadPhotoData();
                
                populateDashboardFilters();
                updateDashboardStats();
                applyDashboardFilters();
                
                if (allPersonnelData.length > 0 && allPersonnelData !== getSampleEmployeeData()) {
                    showNotification(`âœ… Dashboard berhasil dimuat dengan ${allPersonnelData.length} data dari form Tally`, 'success');
                    
                    // Show additional info about data source
                    setTimeout(() => {
                        showNotification(`ğŸ“Š Dashboard terintegrasi dengan form: https://tally.so/r/wdL77d`, 'info');
                    }, 2000);
                } else {
                    showNotification(`ğŸ“‹ Dashboard menggunakan data sample (${allPersonnelData.length} karyawan)`, 'info');
                }
                
            } catch (error) {
                console.error('Error loading dashboard data from Tally integration:', error);
                
                // Fallback to sample data
                allPersonnelData = getSampleEmployeeData();
                
                document.getElementById('personnelGrid').innerHTML = 
                    '<div class="col-span-full text-center py-8 text-amber-600">âš ï¸ Gagal memuat data dari form Tally. Menggunakan data sample.</div>';
                
                showNotification('âš ï¸ Dashboard menggunakan data sample karena gagal memuat dari form Tally', 'error');
                
                // Still populate filters and stats with sample data
                populateDashboardFilters();
                updateDashboardStats();
                applyDashboardFilters();
                
            } finally {
                loadingIndicator.classList.add('hidden');
                refreshIcon.textContent = 'ğŸ”„';
            }
        }

        // Load photo data from multiple sources
        async function loadPhotoData() {
            personnelPhotos = {};
            
            try {
                // 1. Load from Tally form submissions (Google Sheets)
                try {
                    const photoResponse = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSnbCHoucU9nLd4H4B5tC8lcdwU95iGO3dPmONAJ3oIawYvBH96ARAoG1a0HWT3aOqnHZh4LzVYIsP8/pub?gid=0&single=true&output=csv');
                    const photoCsvText = await photoResponse.text();
                    
                    if (photoCsvText && photoCsvText.trim().length > 0) {
                        const photoLines = photoCsvText.split('\n').filter(line => line.trim());
                        
                        if (photoLines.length > 1) {
                            const photoHeaders = parseCSVLine(photoLines[0]).map(h => h.trim().replace(/"/g, ''));
                            console.log('Photo headers found:', photoHeaders);
                            
                            for (let i = 1; i < photoLines.length; i++) {
                                if (photoLines[i].trim()) {
                                    const values = parseCSVLine(photoLines[i]);
                                    const photo = {};
                                    photoHeaders.forEach((header, index) => {
                                        photo[header] = (values[index] || '').trim().replace(/"/g, '');
                                    });
                                    
                                    // Map photo to employee by Nopek - check multiple possible field names
                                    const nopek = photo.Nopek || photo.nopek || photo.NOPEK || photo['Employee ID'] || photo['ID Karyawan'];
                                    const photoUrl = photo['Link Foto'] || photo['Photo URL'] || photo['Foto'] || photo.Photo || photo.Image;
                                    
                                    if (nopek && photoUrl && photoUrl.startsWith('http')) {
                                        personnelPhotos[nopek] = {
                                            photoUrl: photoUrl,
                                            uploadDate: photo['Tanggal Upload'] || photo['Upload Date'] || photo.Date || '',
                                            notes: photo.Catatan || photo.Notes || photo.Keterangan || '',
                                            source: 'form'
                                        };
                                        console.log(`Photo loaded for ${nopek}:`, photoUrl);
                                    }
                                }
                            }
                        }
                    }
                } catch (photoError) {
                    console.log('Could not load photos from form submissions:', photoError.message);
                }
                
                // 2. Load from localStorage (manual uploads)
                const localPhotos = JSON.parse(localStorage.getItem('employeePhotos') || '{}');
                Object.keys(localPhotos).forEach(nopek => {
                    if (localPhotos[nopek] && localPhotos[nopek].photoData) {
                        // Only use localStorage photo if no form photo exists
                        if (!personnelPhotos[nopek]) {
                            personnelPhotos[nopek] = {
                                photoUrl: localPhotos[nopek].photoData,
                                uploadDate: localPhotos[nopek].uploadDate || '',
                                notes: localPhotos[nopek].notes || '',
                                source: 'local'
                            };
                        }
                    }
                });
                
                // 3. Load from form uploaded photos (temporary storage)
                const formPhotos = JSON.parse(localStorage.getItem('formUploadedPhotos') || '{}');
                Object.keys(formPhotos).forEach(nopek => {
                    if (formPhotos[nopek] && formPhotos[nopek].photoData) {
                        // Form photos take priority over localStorage
                        personnelPhotos[nopek] = {
                            photoUrl: formPhotos[nopek].photoData,
                            uploadDate: formPhotos[nopek].uploadDate || '',
                            notes: formPhotos[nopek].notes || '',
                            source: 'form_temp'
                        };
                    }
                });
                
                console.log('Total photos loaded:', Object.keys(personnelPhotos).length);
                console.log('Photos by source:', {
                    form: Object.values(personnelPhotos).filter(p => p.source === 'form').length,
                    local: Object.values(personnelPhotos).filter(p => p.source === 'local').length,
                    form_temp: Object.values(personnelPhotos).filter(p => p.source === 'form_temp').length
                });
                
            } catch (error) {
                console.error('Error loading photo data:', error);
            }
        }

        // Populate dashboard filters
        function populateDashboardFilters() {
            const departments = [...new Set(allPersonnelData.map(emp => emp.Departemen).filter(d => d))].sort();
            
            const departmentFilter = document.getElementById('dashboardDepartmentFilter');
            departmentFilter.innerHTML = '<option value="">Semua Departemen</option>';
            
            departments.forEach(dept => {
                departmentFilter.innerHTML += `<option value="${dept}">${dept}</option>`;
            });
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            // Always show full statistics from database, regardless of user role
            const dataForStats = allPersonnelData;
            
            const totalEmployees = dataForStats.length;
            const activeEmployees = dataForStats.filter(emp => emp.Status === 'Aktif').length;
            const employeesWithPhotos = dataForStats.filter(emp => personnelPhotos[emp.Nopek]).length;
            const totalDepartments = [...new Set(dataForStats.map(emp => emp.Departemen).filter(d => d))].length;
            
            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('activeEmployees').textContent = activeEmployees;
            document.getElementById('employeesWithPhotos').textContent = employeesWithPhotos;
            document.getElementById('totalDepartments').textContent = totalDepartments;
        }

        // Apply dashboard filters
        function applyDashboardFilters() {
            const searchTerm = document.getElementById('dashboardSearch').value.toLowerCase();
            const departmentFilter = document.getElementById('dashboardDepartmentFilter').value;
            const statusFilter = document.getElementById('dashboardStatusFilter').value;
            
            let dataToFilter = allPersonnelData;
            
            // Filter data based on user role for display only
            if (userRole === 'staff' && currentUser && userAccounts[currentUser].nopek) {
                // Staff can only see their own data in the cards display
                const staffNopek = userAccounts[currentUser].nopek;
                dataToFilter = allPersonnelData.filter(employee => employee.Nopek === staffNopek);
            }
            
            filteredPersonnelData = dataToFilter.filter(employee => {
                const matchesSearch = !searchTerm || 
                    Object.values(employee).some(value => 
                        value.toString().toLowerCase().includes(searchTerm)
                    );
                
                const matchesDepartment = !departmentFilter || employee.Departemen === departmentFilter;
                const matchesStatus = !statusFilter || employee.Status === statusFilter;
                
                return matchesSearch && matchesDepartment && matchesStatus;
            });
            
            currentDashboardPage = 1;
            displayPersonnelCards();
            updateDashboardPagination();
            updateDashboardDataInfo();
        }

        // Display personnel cards
        function displayPersonnelCards() {
            const grid = document.getElementById('personnelGrid');
            
            const startIndex = (currentDashboardPage - 1) * personnelPerPage;
            const endIndex = startIndex + personnelPerPage;
            const currentPersonnel = filteredPersonnelData.slice(startIndex, endIndex);
            
            if (currentPersonnel.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">ğŸ“­ Tidak ada data personel yang ditemukan</div>';
                return;
            }
            
            grid.innerHTML = currentPersonnel.map(employee => {
                const photoData = personnelPhotos[employee.Nopek];
                const hasPhoto = photoData && photoData.photoUrl;
                
                // Debug log for photo data
                if (photoData) {
                    console.log(`Photo data for ${employee.Nopek}:`, photoData);
                }
                
                return `
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 border border-gray-100">
                        <div class="p-6">
                            <!-- Photo Section -->
                            <div class="text-center mb-4">
                                <div class="w-24 h-24 mx-auto rounded-full overflow-hidden bg-gradient-to-br from-blue-100 to-indigo-100 flex items-center justify-center shadow-lg">
                                    ${hasPhoto ? 
                                        `<img src="${photoData.photoUrl}" 
                                             alt="Foto ${employee['Nama Lengkap']}" 
                                             class="w-full h-full object-cover" 
                                             onerror="console.error('Failed to load photo for ${employee.Nopek}:', this.src); this.parentElement.innerHTML='<span class=\\"text-3xl text-blue-600\\">ğŸ‘¤</span><div class=\\"text-xs text-red-500 mt-1\\">Foto Error</div>'"
                                             onload="console.log('Photo loaded successfully for ${employee.Nopek}')">` :
                                        `<span class="text-3xl text-blue-600">ğŸ‘¤</span>`
                                    }
                                </div>
                                ${hasPhoto ? 
                                    `<div class="mt-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            ğŸ“· Foto Tersedia ${photoData.source ? `(${photoData.source})` : ''}
                                        </span>
                                    </div>` : 
                                    `<div class="mt-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                            ğŸ“· Belum Ada Foto
                                        </span>
                                    </div>`
                                }
                            </div>
                            
                            <!-- Employee Info -->
                            <div class="text-center space-y-2">
                                <h3 class="font-bold text-lg text-gray-900 truncate" title="${employee['Nama Lengkap'] || '-'}">${employee['Nama Lengkap'] || '-'}</h3>
                                
                                <div class="space-y-1">
                                    <p class="text-sm text-gray-600">
                                        <span class="font-medium">Nopek:</span> ${employee.Nopek || '-'}
                                    </p>
                                    <p class="text-sm text-gray-600 truncate" title="${employee.Jabatan || '-'}">
                                        <span class="font-medium">Jabatan:</span> ${employee.Jabatan || '-'}
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <span class="font-medium">Umur:</span> ${employee.Umur || '-'} tahun
                                    </p>
                                </div>
                                
                                <!-- Department Badge -->
                                <div class="pt-2">
                                    <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                        ${employee.Departemen || 'Tidak Ada Departemen'}
                                    </span>
                                </div>
                                
                                <!-- Status Badge -->
                                <div>
                                    <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full ${
                                        employee.Status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }">
                                        ${employee.Status || 'Tidak Diketahui'}
                                    </span>
                                </div>
                                
                                <!-- Contact Info -->
                                ${employee.Email ? 
                                    `<div class="pt-2">
                                        <a href="mailto:${employee.Email}" class="text-xs text-blue-600 hover:text-blue-800 truncate block" title="${employee.Email}">
                                            ğŸ“§ ${employee.Email}
                                        </a>
                                    </div>` : ''
                                }
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="mt-4 flex gap-2">
                                <button onclick="viewPersonnelDetail('${employee.Nopek}')" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs py-2 px-3 rounded-lg transition-colors">
                                    ğŸ‘ï¸ Detail
                                </button>
                                <button onclick="editPersonnelData('${employee.Nopek}', '${employee['Nama Lengkap']}')" 
                                        class="flex-1 bg-green-600 hover:bg-green-700 text-white text-xs py-2 px-3 rounded-lg transition-colors">
                                    ğŸ“Š Edit
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View personnel detail
        function viewPersonnelDetail(nopek) {
            const employee = allPersonnelData.find(emp => emp.Nopek === nopek);
            if (!employee) return;
            
            // Close dashboard modal when viewing detail
            closeDashboard();
            
            const photoData = personnelPhotos[nopek];
            
            // Create detail modal content with lower z-index than dashboard
            const detailHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-30 z-40 flex items-center justify-center" id="personnelDetailModal">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Detail Personel</h3>
                                <button onclick="closePersonnelDetail()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Photo Section -->
                                <div class="text-center">
                                    <div class="w-32 h-40 mx-auto rounded-lg overflow-hidden bg-gradient-to-br from-blue-100 to-indigo-100 flex items-center justify-center shadow-lg">
                                        ${photoData && photoData.photoUrl ? 
                                            `<img src="${photoData.photoUrl}" 
                                                 alt="Foto ${employee['Nama Lengkap']}" 
                                                 class="w-full h-full object-cover" 
                                                 onerror="console.error('Failed to load photo in detail for ${employee.Nopek}:', this.src); this.parentElement.innerHTML='<span class=\\"text-4xl text-blue-600\\">ğŸ‘¤</span><div class=\\"text-xs text-red-500 mt-1\\">Foto Error</div>'"
                                                 onload="console.log('Detail photo loaded successfully for ${employee.Nopek}')">` :
                                            `<span class="text-4xl text-blue-600">ğŸ‘¤</span>`
                                        }
                                    </div>
                                    ${photoData && photoData.photoUrl ? 
                                        `<p class="text-xs text-green-600 mt-2">ğŸ“· Foto tersedia (${photoData.source || 'unknown'})</p>
                                         ${photoData.uploadDate ? `<p class="text-xs text-gray-500">Upload: ${photoData.uploadDate}</p>` : ''}` : 
                                        `<p class="text-xs text-gray-500 mt-2">ğŸ“· Belum ada foto</p>`
                                    }
                                </div>
                                
                                <!-- Details Section -->
                                <div class="md:col-span-2 space-y-4">
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                            <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-2 rounded">${employee['Nama Lengkap'] || '-'}</p>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Nopek</label>
                                                <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-2 rounded">${employee.Nopek || '-'}</p>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Umur</label>
                                                <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-2 rounded">${employee.Umur || '-'} tahun</p>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Jabatan</label>
                                            <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-2 rounded">${employee.Jabatan || '-'}</p>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Departemen</label>
                                                <p class="mt-1 text-sm text-gray-900 bg-blue-50 p-2 rounded">${employee.Departemen || '-'}</p>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Status</label>
                                                <p class="mt-1 text-sm ${employee.Status === 'Aktif' ? 'text-green-800 bg-green-50' : 'text-red-800 bg-red-50'} p-2 rounded">${employee.Status || '-'}</p>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Email</label>
                                            <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-2 rounded">${employee.Email ? `<a href="mailto:${employee.Email}" class="text-blue-600 hover:text-blue-800">${employee.Email}</a>` : '-'}</p>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Tempat Kerja</label>
                                            <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-2 rounded">${employee['Tempat Kerja'] || '-'}</p>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Tempat Lahir</label>
                                                <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-2 rounded">${employee['Tempat Lahir'] || '-'}</p>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                                                <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-2 rounded">${employee['Tanggal Lahir'] || '-'}</p>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Alamat</label>
                                            <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-2 rounded">${employee.Alamat || '-'}</p>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">No. HP</label>
                                            <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-2 rounded">${employee['No. HP'] || '-'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border-t pt-4 mt-6">
                                <div class="flex gap-3">
                                    <button onclick="closePersonnelDetail()" 
                                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-colors">
                                        Tutup
                                    </button>
                                    <button onclick="closePersonnelDetail(); editPersonnelData('${employee.Nopek}', '${employee['Nama Lengkap']}')" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors">
                                        âœï¸ Edit Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', detailHTML);
        }

        // Close personnel detail
        function closePersonnelDetail() {
            const modal = document.getElementById('personnelDetailModal');
            if (modal) {
                modal.remove();
            }
        }

        // Update dashboard pagination
        function updateDashboardPagination() {
            const pagination = document.getElementById('dashboardPagination');
            const totalPages = Math.ceil(filteredPersonnelData.length / personnelPerPage);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            if (currentDashboardPage > 1) {
                paginationHTML += `<button onclick="changeDashboardPage(${currentDashboardPage - 1})" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">â€¹ Prev</button>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentDashboardPage - 2);
            const endPage = Math.min(totalPages, currentDashboardPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button onclick="changeDashboardPage(1)" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="px-3 py-2">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button onclick="changeDashboardPage(${i})" class="px-3 py-2 ${
                    i === currentDashboardPage ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg' : 'bg-gray-200 hover:bg-gradient-to-r hover:from-blue-100 hover:to-indigo-100 hover:text-blue-800'
                } rounded-lg transition-all duration-300">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="px-3 py-2">...</span>`;
                }
                paginationHTML += `<button onclick="changeDashboardPage(${totalPages})" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">${totalPages}</button>`;
            }
            
            // Next button
            if (currentDashboardPage < totalPages) {
                paginationHTML += `<button onclick="changeDashboardPage(${currentDashboardPage + 1})" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">Next â€º</button>`;
            }
            
            pagination.innerHTML = paginationHTML;
        }

        // Change dashboard page
        function changeDashboardPage(page) {
            currentDashboardPage = page;
            displayPersonnelCards();
            updateDashboardPagination();
            updateDashboardDataInfo();
        }

        // Update dashboard data info
        function updateDashboardDataInfo() {
            const startIndex = (currentDashboardPage - 1) * personnelPerPage + 1;
            const endIndex = Math.min(currentDashboardPage * personnelPerPage, filteredPersonnelData.length);
            
            document.getElementById('dashboardShowingStart').textContent = filteredPersonnelData.length > 0 ? startIndex : 0;
            document.getElementById('dashboardShowingEnd').textContent = endIndex;
            document.getElementById('dashboardTotalEntries').textContent = filteredPersonnelData.length;
        }

        // Refresh dashboard
        function refreshDashboard() {
            loadDashboardData();
        }

        // Export personnel data
        function exportPersonnelData() {
            showNotification('ğŸ“Š Mengekspor data personel...', 'info');
            
            // Create CSV content
            let csvContent = 'Nopek,Nama Lengkap,Jabatan,Departemen,Umur,Email,Status,Foto Tersedia\n';
            
            filteredPersonnelData.forEach(employee => {
                const hasPhoto = personnelPhotos[employee.Nopek] ? 'Ya' : 'Tidak';
                csvContent += `"${employee.Nopek || ''}","${employee['Nama Lengkap'] || ''}","${employee.Jabatan || ''}","${employee.Departemen || ''}","${employee.Umur || ''}","${employee.Email || ''}","${employee.Status || ''}","${hasPhoto}"\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `data_personel_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('âœ… Data personel berhasil diekspor', 'success');
        }

        // Edit personnel data (opens Google Spreadsheet in modal)
        function editPersonnelData(nopek, name) {
            // Show notification
            showNotification(`âœï¸ Membuka spreadsheet untuk edit data ${name} (${nopek})`, 'info');
            
            // Open edit data modal with iframe
            openEditDataModal(nopek, name);
        }

        // Open data input form for specific employee (opens in modal)
        function openDataInputForm(nopek, name) {
            // Show notification
            showNotification(`âœï¸ Membuka spreadsheet untuk edit data ${name} (${nopek})`, 'info');
            
            // Open edit data modal with iframe
            openEditDataModal(nopek, name);
        }

        // Open Edit Data Modal
        function openEditDataModal(nopek, name) {
            // Set employee info in modal
            document.getElementById('editEmployeeNopek').textContent = nopek;
            document.getElementById('editEmployeeName').textContent = name;
            
            // Show modal
            document.getElementById('editDataModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Hide success message when opening
            document.getElementById('editDataSuccessMessage').classList.add('hidden');
            
            showNotification(`âœï¸ Membuka editor untuk ${name} (${nopek})`, 'info');
        }

        // Close Edit Data Modal
        function closeEditDataModal() {
            document.getElementById('editDataModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Refresh Edit Data Spreadsheet
        function refreshEditDataSpreadsheet() {
            const iframe = document.getElementById('editDataFrame');
            iframe.src = 'https://docs.google.com/spreadsheets/d/1En78lujaSddXeQ3lXQNWTe48C-6GpQ2lvApxiuqccBQ/edit?usp=sharing';
            showNotification('ğŸ”„ Spreadsheet edit data berhasil di-refresh', 'success');
            
            // Hide success message when refreshing
            document.getElementById('editDataSuccessMessage').classList.add('hidden');
        }

        // Refresh data after edit
        function refreshDataAfterEdit() {
            // Show success message
            document.getElementById('editDataSuccessMessage').classList.remove('hidden');
            
            // Refresh employee data from the spreadsheet
            loadEmployeeData();
            
            // Also refresh dashboard data if available
            if (allPersonnelData.length > 0) {
                loadDashboardData();
            }
            
            showNotification('ğŸ”„ Data karyawan berhasil diperbarui dari database', 'success');
            
            // Auto-hide success message after 5 seconds
            setTimeout(() => {
                document.getElementById('editDataSuccessMessage').classList.add('hidden');
            }, 5000);
        }

        // Enhanced refresh function to reload dashboard data after input
        function refreshDashboardAfterInput() {
            showNotification('ğŸ”„ Memperbarui data dashboard...', 'info');
            
            // Clear stored employee selection
            localStorage.removeItem('selectedEmployeeNopek');
            localStorage.removeItem('selectedEmployeeName');
            
            // Reload dashboard data to get latest data
            setTimeout(() => {
                loadDashboardData();
                showNotification('âœ… Dashboard berhasil diperbarui dengan data terbaru', 'success');
            }, 2000);
        }

        // Add event listeners for dashboard filters
        document.getElementById('dashboardSearch').addEventListener('input', applyDashboardFilters);
        document.getElementById('dashboardDepartmentFilter').addEventListener('change', applyDashboardFilters);
        document.getElementById('dashboardStatusFilter').addEventListener('change', applyDashboardFilters);

        // Close modals when clicking outside
        document.getElementById('dashboardModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDashboard();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePhotoUpload();
                closePhotoView();
                closeInputDataKaryawan();
                closeInputLaporan();
                closeDisplayLaporan();
                closePrintLaporan();
                closeDashboard();
                closePersonnelDetail();
                closeEditDataModal();
                closeUserManagement();
                closeResetPassword();
                closeAddNewAccount();
                closeBackupRestore();
                closeDataValidation();
                closeSystemSettings();
                closeHelp();
                closeAbout();
            }
        });

        // Settings Modal Functions
        function openBackupRestore() {
            document.getElementById('backupRestoreModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('ğŸ’¾ Membuka menu backup & restore', 'info');
        }

        function closeBackupRestore() {
            document.getElementById('backupRestoreModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function openDataValidation() {
            document.getElementById('dataValidationModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('âœ… Membuka validasi data', 'info');
        }

        function closeDataValidation() {
            document.getElementById('dataValidationModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function openDataSync() {
            showNotification('ğŸ”„ Fitur sinkronisasi data akan segera tersedia', 'info');
        }

        function openUserManagement() {
            showNotification('ğŸ‘¥ Fitur manajemen user akan segera tersedia', 'info');
        }

        function openSystemSettings() {
            document.getElementById('systemSettingsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('âš™ï¸ Membuka pengaturan sistem', 'info');
        }

        function closeSystemSettings() {
            document.getElementById('systemSettingsModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function openAuditLog() {
            showNotification('ğŸ“‹ Fitur log aktivitas akan segera tersedia', 'info');
        }

        function openHelp() {
            document.getElementById('helpModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('â“ Membuka bantuan & tutorial', 'info');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function openAbout() {
            document.getElementById('aboutModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            showNotification('â„¹ï¸ Membuka informasi sistem', 'info');
        }

        function closeAbout() {
            document.getElementById('aboutModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Backup & Restore Functions
        function createBackup() {
            showNotification('ğŸ’¾ Membuat backup data...', 'info');
            
            // Simulate backup process
            setTimeout(() => {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    employees: allEmployees,
                    reports: allReports || [],
                    photos: uploadedPhotos,
                    settings: {
                        version: 'v2.1.0',
                        exportDate: new Date().toISOString()
                    }
                };
                
                // Create and download backup file
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                link.href = url;
                link.download = `backup_pertamina_${timestamp}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                showNotification('âœ… Backup berhasil dibuat dan diunduh', 'success');
                
                // Update backup history
                updateBackupHistory();
            }, 2000);
        }

        function restoreData() {
            showNotification('ğŸ“¥ Fitur restore akan segera tersedia', 'info');
        }

        function updateBackupHistory() {
            const historyContainer = document.getElementById('backupHistory');
            const now = new Date();
            const newBackup = `
                <div class="flex items-center justify-between bg-white p-3 rounded-lg">
                    <div>
                        <p class="font-medium text-sm">backup_${now.toISOString().slice(0, 10)}_${now.toTimeString().slice(0, 5).replace(':', '-')}.json</p>
                        <p class="text-xs text-gray-500">${now.toLocaleDateString('id-ID', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })} WIB</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="text-blue-600 hover:text-blue-800 text-sm">ğŸ“¥ Restore</button>
                        <button class="text-red-600 hover:text-red-800 text-sm">ğŸ—‘ï¸ Hapus</button>
                    </div>
                </div>
            `;
            historyContainer.insertAdjacentHTML('afterbegin', newBackup);
        }

        // Data Validation Functions
        function runDataValidation() {
            showNotification('ğŸ” Menjalankan validasi data...', 'info');
            
            const validationResults = document.getElementById('validationResults');
            validationResults.innerHTML = '<div class="text-center text-gray-500 py-4">Memproses validasi data...</div>';
            
            setTimeout(() => {
                let validCount = 0;
                let warningCount = 0;
                let errorCount = 0;
                let results = [];
                
                // Validate employee data
                allEmployees.forEach((employee, index) => {
                    // Check required fields
                    if (!employee.Nopek || !employee['Nama Lengkap']) {
                        errorCount++;
                        results.push({
                            type: 'error',
                            message: `Baris ${index + 1}: Nopek atau Nama Lengkap kosong`,
                            data: employee
                        });
                    } else if (!employee.Email || !employee.Email.includes('@')) {
                        warningCount++;
                        results.push({
                            type: 'warning',
                            message: `${employee['Nama Lengkap']}: Email tidak valid atau kosong`,
                            data: employee
                        });
                    } else if (!employee['No. HP'] || employee['No. HP'].length < 10) {
                        warningCount++;
                        results.push({
                            type: 'warning',
                            message: `${employee['Nama Lengkap']}: Nomor HP tidak valid`,
                            data: employee
                        });
                    } else {
                        validCount++;
                        if (results.length < 5) { // Show only first few valid entries
                            results.push({
                                type: 'valid',
                                message: `${employee['Nama Lengkap']}: Data lengkap dan valid`,
                                data: employee
                            });
                        }
                    }
                });
                
                // Update counters
                document.getElementById('validDataCount').textContent = validCount;
                document.getElementById('warningDataCount').textContent = warningCount;
                document.getElementById('errorDataCount').textContent = errorCount;
                
                // Display results
                validationResults.innerHTML = results.map(result => {
                    const colors = {
                        valid: 'bg-green-50 border-green-200 text-green-800',
                        warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                        error: 'bg-red-50 border-red-200 text-red-800'
                    };
                    const icons = {
                        valid: 'âœ…',
                        warning: 'âš ï¸',
                        error: 'âŒ'
                    };
                    
                    return `
                        <div class="border rounded-lg p-3 ${colors[result.type]}">
                            <div class="flex items-start gap-2">
                                <span>${icons[result.type]}</span>
                                <div class="flex-1">
                                    <p class="text-sm font-medium">${result.message}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                showNotification(`âœ… Validasi selesai: ${validCount} valid, ${warningCount} peringatan, ${errorCount} error`, 'success');
            }, 3000);
        }

        // System Settings Functions
        function saveSystemSettings() {
            showNotification('ğŸ’¾ Menyimpan pengaturan sistem...', 'info');
            
            setTimeout(() => {
                showNotification('âœ… Pengaturan sistem berhasil disimpan', 'success');
                closeSystemSettings();
            }, 1500);
        }

        // Help Functions
        function contactSupport() {
            showNotification('ğŸ“ Menghubungkan ke support...', 'info');
            
            // Simulate opening support contact
            setTimeout(() => {
                const supportInfo = `
                    ğŸ“ Support PT Pertamina Drilling
                    
                    Email: support@pertamina-drilling.com
                    Phone: +62 713 326800
                    WhatsApp: +62 812-3456-7890
                    
                    Jam Operasional:
                    Senin - Jumat: 08:00 - 17:00 WIB
                    Sabtu: 08:00 - 12:00 WIB
                `;
                
                showNotification('ğŸ“ Informasi kontak support telah disalin', 'success');
                
                // Copy to clipboard if possible
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(supportInfo);
                }
            }, 1000);
        }

        // About Functions
        function checkUpdates() {
            showNotification('ğŸ”„ Memeriksa update sistem...', 'info');
            
            setTimeout(() => {
                showNotification('âœ… Sistem sudah menggunakan versi terbaru (v2.1.0)', 'success');
            }, 2000);
        }

        // Close modals when clicking outside
        document.getElementById('backupRestoreModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBackupRestore();
            }
        });

        document.getElementById('dataValidationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDataValidation();
            }
        });

        document.getElementById('systemSettingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSystemSettings();
            }
        });

        document.getElementById('helpModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHelp();
            }
        });

        document.getElementById('aboutModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAbout();
            }
        });

        document.getElementById('userManagementModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUserManagement();
            }
        });

        document.getElementById('resetPasswordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeResetPassword();
            }
        });

        document.getElementById('editDataModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditDataModal();
            }
        });

        document.getElementById('addNewAccountModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddNewAccount();
            }
        });

        // Initialize page on load (only after login)
        function initializePage() {
            // Start clock
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Normalize role for comparison
            const normalizedRole = userRole ? userRole.toLowerCase() : '';
            
            // Load employee data for both dashboard and table (for admin and administrator)
            if (normalizedRole === 'admin' || normalizedRole === 'administrator') {
                loadEmployeeData();
                // Show dashboard as default landing page for admin
                showDashboard();
            } else if (normalizedRole === 'staff') {
                // For staff, show a welcome message and direct to laporan
                showNotification('ğŸ‘‹ Selamat datang! Silakan gunakan menu Laporan untuk mengakses fitur yang tersedia', 'info');
                
                // Hide dashboard and data karyawan sections
                document.getElementById('mainDashboard').classList.add('hidden');
                document.getElementById('dataKaryawanSection').classList.add('hidden');
                
                // Show a staff welcome screen
                showStaffWelcomeScreen();
            } else {
                // For viewer or other roles, load data but show dashboard
                loadEmployeeData();
                showDashboard();
            }
        }
        
        // Show staff welcome screen
        function showStaffWelcomeScreen() {
            const mainContent = document.querySelector('#mainDashboard');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="container mx-auto px-4 pb-8">
                        <div class="max-w-4xl mx-auto">
                            <!-- Welcome Header -->
                            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl shadow-2xl p-8 mb-8">
                                <div class="text-center">
                                    <div class="text-6xl mb-4">ğŸ‘‹</div>
                                    <h1 class="text-3xl font-bold mb-2">Selamat Datang, ${userAccounts[currentUser].name}!</h1>
                                    <p class="text-blue-100 text-lg">Role: Staff - PT Pertamina Drilling</p>
                                    <p class="text-blue-200 text-sm mt-2">Sistem Manajemen Laporan Operasional</p>
                                </div>
                            </div>

                            <!-- Available Features -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <span class="text-3xl">ğŸ“</span>
                                        </div>
                                        <h3 class="text-xl font-bold text-gray-900 mb-2">Input Laporan</h3>
                                        <p class="text-gray-600 text-sm mb-4">Buat dan submit laporan aktivitas operasional harian</p>
                                        <button onclick="openInputLaporan()" 
                                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                                            ğŸ“ Buat Laporan
                                        </button>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <span class="text-3xl">ğŸ–¨ï¸</span>
                                        </div>
                                        <h3 class="text-xl font-bold text-gray-900 mb-2">Print Laporan</h3>
                                        <p class="text-gray-600 text-sm mb-4">Cetak laporan dalam berbagai format dan periode</p>
                                        <button onclick="openPrintLaporan()" 
                                                class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition-colors">
                                            ğŸ–¨ï¸ Print Laporan
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Access -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Akses Cepat</h3>
                                <div class="flex flex-wrap justify-center gap-4">
                                    <button onclick="openInputLaporan()" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                                        <span>ğŸ“</span> Input Laporan Baru
                                    </button>
                                    <button onclick="openDisplayLaporan()" 
                                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                                        <span>ğŸ“Š</span> Lihat Laporan
                                    </button>
                                    <button onclick="openPrintLaporan()" 
                                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                                        <span>ğŸ–¨ï¸</span> Print Laporan
                                    </button>
                                </div>
                            </div>

                            <!-- Information -->
                            <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-start gap-3">
                                    <span class="text-blue-600 text-lg">â„¹ï¸</span>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-semibold mb-1">Informasi Akses Staff:</p>
                                        <ul class="list-disc list-inside space-y-1 text-xs">
                                            <li>Anda memiliki akses penuh ke semua fitur laporan</li>
                                            <li>Gunakan menu "Laporan" di navigasi atas untuk mengakses fitur</li>
                                            <li>Akses dashboard dan data karyawan terbatas untuk Administrator</li>
                                            <li>Hubungi Administrator jika memerlukan akses tambahan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                mainContent.classList.remove('hidden');
            }
        }

        // Don't auto-initialize - wait for login
        // initializePage() is called from showMainApplication() after successful login
    </script>
  </div><!-- End of mainApplication div -->
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99813d1003eefd0c',t:'MTc2MjA2MTQxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>